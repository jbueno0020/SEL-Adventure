import React, { useState, useEffect } from 'react';

// ========== SCENARIO DATA ==========

const elementaryScenarios = [
  {
    id: 'e1', title: "The Rushed Morning", timeOfDay: "ğŸŒ… Morning at Home", timeOrder: 1,
    situation: "You woke up late and now you're rushing to get ready. Your mom says you don't have time for your favorite cerealâ€”you have to eat something quick.",
    choices: [
      { text: "Say 'okay' and grab a banana to eat on the way", points: 2, skill: "Flexibility", consequence: "You make it to school on time with food in your belly. Mom thanks you for being so cooperative!", emoji: "ğŸ’š" },
      { text: "Feel disappointed but grab a granola bar without complaining", points: 1, skill: "Acceptance", consequence: "You get to school okay. Not your favorite breakfast, but you handled it well.", emoji: "ğŸ’™" },
      { text: "Whine and say 'But I ALWAYS have my cereal!'", points: -1, skill: "Inflexibility", consequence: "Mom gets more stressed and now everyone is frustrated. You still don't get the cereal.", emoji: "ğŸŸ " },
      { text: "Throw yourself on the couch and refuse to move", points: -2, skill: "Tantrum", consequence: "Now you're really late AND hungry. Mom is upset and you start the day feeling terrible.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e2', title: "The Missing Shoe", timeOfDay: "ğŸŒ… Morning at Home", timeOrder: 1,
    situation: "You can only find one of your shoes and the bus is coming in 5 minutes. You're starting to panic!",
    choices: [
      { text: "Take a deep breath and think about where you last had them", points: 2, skill: "Problem-Solving", consequence: "You remember you kicked them off by the couch! You find your shoe and make it to the bus.", emoji: "ğŸ’š" },
      { text: "Ask a grown-up to help you look", points: 1, skill: "Help-Seeking", consequence: "Dad helps you look and finds it under your bed. You make it to the bus!", emoji: "ğŸ’™" },
      { text: "Start crying and say you can't go to school", points: -1, skill: "Overwhelm", consequence: "The crying uses up time. Someone finds the shoe but now you feel embarrassed.", emoji: "ğŸŸ " },
      { text: "Get mad and throw the shoe you DID find", points: -2, skill: "Aggression", consequence: "Now you might have TWO missing shoes! Plus you're in trouble for throwing things.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e3', title: "The Bus Seat", timeOfDay: "ğŸšŒ Bus Ride", timeOrder: 2,
    situation: "You get on the bus and see that someone is sitting in the seat where you usually sit with your friend.",
    choices: [
      { text: "Find another seat and wave to your friendâ€”you can talk at school", points: 2, skill: "Flexible Thinking", consequence: "You sit somewhere new and actually make a new friend! Your regular friend waves back.", emoji: "ğŸ’š" },
      { text: "Politely ask if you can squeeze in", points: 1, skill: "Assertiveness", consequence: "Everyone scoots over to make room. You get to sit with your friend!", emoji: "ğŸ’™" },
      { text: "Stand in the aisle and stare at them until they move", points: -1, skill: "Passive Confrontation", consequence: "The bus driver tells you to sit down. You feel embarrassed.", emoji: "ğŸŸ " },
      { text: "Tell them loudly 'That's MY seat! Move!'", points: -2, skill: "Aggression", consequence: "The other kid feels bad and the bus driver gives you a warning.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e4', title: "The Hard Math Problem", timeOfDay: "ğŸ“š 1st Period - Math", timeOrder: 3,
    situation: "Your teacher puts a math problem on the board and you have no idea how to solve it. Other kids are raising their hands.",
    choices: [
      { text: "Raise your hand and ask the teacher to explain it differently", points: 2, skill: "Help-Seeking", consequence: "The teacher explains it again and suddenly it makes sense! Other kids thank you too.", emoji: "ğŸ’š" },
      { text: "Look at the example problems in your book for hints", points: 1, skill: "Independence", consequence: "The book helps! You get part of it right and feel proud for trying.", emoji: "ğŸ’™" },
      { text: "Put your head down and hope the teacher doesn't call on you", points: -1, skill: "Avoidance", consequence: "You don't learn how to do it. Hiding didn't help.", emoji: "ğŸŸ " },
      { text: "Say loudly 'This is stupid! Math is dumb!'", points: -2, skill: "Outburst", consequence: "The teacher talks to you about being respectful. Now you're embarrassed AND confused.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e5', title: "The Group Project", timeOfDay: "ğŸ“– 2nd Period - Reading", timeOrder: 4,
    situation: "Your teacher puts you in a group with kids you don't usually play with. One of them wants to be the boss.",
    choices: [
      { text: "Share your ideas calmly and ask what others think too", points: 2, skill: "Collaboration", consequence: "The group starts working together! The bossy kid even likes your idea.", emoji: "ğŸ’š" },
      { text: "Go along with their ideas and do your part", points: 1, skill: "Cooperation", consequence: "The project gets done. Maybe next time you can share more ideas.", emoji: "ğŸ’™" },
      { text: "Cross your arms and refuse to participate", points: -1, skill: "Withdrawal", consequence: "Your group struggles and you feel left out.", emoji: "ğŸŸ " },
      { text: "Say 'You're not the boss of me!' and argue about everything", points: -2, skill: "Defiance", consequence: "Now there's fighting. No one is having fun and the project isn't done.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e6', title: "The Recess Game", timeOfDay: "âš½ Recess", timeOrder: 5,
    situation: "You want to play soccer but the teams are already picked and both sides say they have enough players.",
    choices: [
      { text: "Ask if you can be a sub and go in when someone needs a break", points: 2, skill: "Creative Problem-Solving", consequence: "They say yes! You get to play and everyone thinks it's fair.", emoji: "ğŸ’š" },
      { text: "Watch for now and ask to play in the next game", points: 1, skill: "Patience", consequence: "When the next game starts, they let you play from the beginning.", emoji: "ğŸ’™" },
      { text: "Walk away sadly and sit alone on the bench", points: -1, skill: "Withdrawal", consequence: "You spend recess feeling lonely. You could have found something else fun!", emoji: "ğŸŸ " },
      { text: "Kick the ball away and say 'Your game is dumb anyway!'", points: -2, skill: "Aggression", consequence: "Now the other kids are mad. They won't want you to play next time either.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e7', title: "The Spilled Snack", timeOfDay: "ğŸ Snack Time", timeOrder: 5,
    situation: "You're opening your snack and it spills all over the floor. Some kids start laughing.",
    choices: [
      { text: "Laugh a little too and say 'Oops! Snack escape!' while you clean up", points: 2, skill: "Humor", consequence: "Other kids laugh WITH you! Someone helps clean up. It becomes a funny moment.", emoji: "ğŸ’š" },
      { text: "Clean it up quietly and don't worry about the laughing", points: 1, skill: "Self-Regulation", consequence: "You handle it calmly. The laughing stops quickly.", emoji: "ğŸ’™" },
      { text: "Start crying because you're embarrassed", points: -1, skill: "Overwhelm", consequence: "Now you're embarrassed AND crying. You feel worse than you needed to.", emoji: "ğŸŸ " },
      { text: "Yell 'Stop laughing!' and knock someone else's snack over", points: -2, skill: "Retaliation", consequence: "Now you're in trouble. Two messes to clean and a trip to see the teacher.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e8', title: "The Art Project", timeOfDay: "ğŸ¨ 3rd Period - Art", timeOrder: 6,
    situation: "You're working hard on a drawing but it doesn't look like what you imagined. The kid next to you has an amazing drawing.",
    choices: [
      { text: "Tell yourself 'I'm still learning' and ask them for tips", points: 2, skill: "Growth Mindset", consequence: "They share a cool technique! Your drawing gets better and you made a new art friend.", emoji: "ğŸ’š" },
      { text: "Keep trying your best and focus on your own paper", points: 1, skill: "Persistence", consequence: "You finish your drawing. It's not perfect but it's YOURS.", emoji: "ğŸ’™" },
      { text: "Crumple up your paper and say 'I'm bad at art'", points: -1, skill: "Giving Up", consequence: "Now you have to start over. You're not badâ€”you just need practice!", emoji: "ğŸŸ " },
      { text: "Say 'Your drawing is weird' to make yourself feel better", points: -2, skill: "Putting Others Down", consequence: "The other kid feels hurt. Being mean didn't make your drawing any better.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e9', title: "The Lunch Table", timeOfDay: "ğŸ• Lunch", timeOrder: 7,
    situation: "You walk into the cafeteria and your usual spot is taken. Your friends are at a full table.",
    choices: [
      { text: "Ask if you can squeeze in, or find a seat nearby", points: 2, skill: "Social Problem-Solving", consequence: "Everyone scoots over! Or you sit nearby and still chat. Lunch is fun!", emoji: "ğŸ’š" },
      { text: "Find a different table and maybe make new friends", points: 1, skill: "Flexibility", consequence: "You meet some new kids who are actually pretty cool!", emoji: "ğŸ’™" },
      { text: "Stand holding your tray looking sad until someone notices", points: -1, skill: "Helplessness", consequence: "You waste lunch time standing around feeling awkward.", emoji: "ğŸŸ " },
      { text: "Push into the table and say 'Move! This is where I sit!'", points: -2, skill: "Aggression", consequence: "You cause a scene and a lunch monitor comes over.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e10', title: "The Science Mistake", timeOfDay: "ğŸ”¬ 4th Period - Science", timeOrder: 8,
    situation: "During an experiment, you accidentally break a piece of equipment. No one saw it happen.",
    choices: [
      { text: "Tell the teacher what happened and say you're sorry", points: 2, skill: "Honesty", consequence: "The teacher thanks you for being honest. Accidents happen and they're not mad!", emoji: "ğŸ’š" },
      { text: "Raise your hand and ask for help cleaning it up", points: 1, skill: "Responsibility", consequence: "The teacher helps you clean up and isn't upset.", emoji: "ğŸ’™" },
      { text: "Hide it and hope nobody notices", points: -1, skill: "Avoidance", consequence: "You feel worried someone will find out. The secret feels heavy.", emoji: "ğŸŸ " },
      { text: "Quickly move away and pretend it was already broken", points: -2, skill: "Dishonesty", consequence: "Later, the teacher asks who broke it. Now you have to lie or admit you hid it.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e11', title: "The PE Challenge", timeOfDay: "ğŸƒ 5th Period - PE", timeOrder: 9,
    situation: "Your class is doing the mile run. You're tired after the first lap and there's still more to go.",
    choices: [
      { text: "Tell yourself 'I can do this' and keep going", points: 2, skill: "Positive Self-Talk", consequence: "You finish! It was hard but you feel SO proud of yourself.", emoji: "ğŸ’š" },
      { text: "Walk when you need to but keep moving forward", points: 1, skill: "Self-Pacing", consequence: "You finish by mixing walking and running. You listened to your body!", emoji: "ğŸ’™" },
      { text: "Stop and say your stomach hurts so you can sit out", points: -1, skill: "Avoidance", consequence: "You sit out but feel bad watching others finish.", emoji: "ğŸŸ " },
      { text: "Complain loudly 'Running is stupid!'", points: -2, skill: "Negativity", consequence: "The PE teacher talks to you about attitude.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e12', title: "The Hurt Feelings", timeOfDay: "ğŸ« End of Day", timeOrder: 10,
    situation: "Your best friend played with someone else at recess and didn't include you. School is ending and you feel hurt.",
    choices: [
      { text: "Tell your friend 'I felt left out. Can we play together tomorrow?'", points: 2, skill: "Expressing Feelings", consequence: "Your friend says sorry and promises to play with you tomorrow! You feel better.", emoji: "ğŸ’š" },
      { text: "Talk to a grown-up about how you're feeling", points: 1, skill: "Seeking Support", consequence: "They help you feel better and give advice for tomorrow.", emoji: "ğŸ’™" },
      { text: "Ignore your friend when they say bye", points: -1, skill: "Passive-Aggression", consequence: "Your friend is confused. They don't know why you're upset.", emoji: "ğŸŸ " },
      { text: "Tell them 'You're not my friend anymore!'", points: -2, skill: "Reactive Rejection", consequence: "You might lose a good friendship over one bad day.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e13', title: "The Homework Surprise", timeOfDay: "ğŸ  After School", timeOrder: 11,
    situation: "You get home and remember you have homework. You really wanted to play outside.",
    choices: [
      { text: "Do homework first, then playâ€”you won't have to worry!", points: 2, skill: "Responsibility", consequence: "You finish and playing after is SO fun because you're not worried!", emoji: "ğŸ’š" },
      { text: "Ask if you can play for 20 minutes then do homework", points: 1, skill: "Negotiation", consequence: "Your grown-up agrees. You keep your promise!", emoji: "ğŸ’™" },
      { text: "Say you don't have homework and hide it", points: -1, skill: "Deception", consequence: "You might forget and get in trouble at school tomorrow.", emoji: "ğŸŸ " },
      { text: "Have a meltdown: 'I don't WANT to do homework!'", points: -2, skill: "Tantrum", consequence: "You still have to do it, but now you're upset AND in trouble.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e14', title: "The Sibling Problem", timeOfDay: "ğŸ  After School", timeOrder: 11,
    situation: "Your brother/sister takes the TV remote and changes what you were watching without asking.",
    choices: [
      { text: "Say 'Hey, I was watching that. Can we take turns?'", points: 2, skill: "Assertiveness", consequence: "You work out a deal to share. Fair!", emoji: "ğŸ’š" },
      { text: "Get a parent to help work it out", points: 1, skill: "Adult Help", consequence: "A grown-up helps make a fair plan.", emoji: "ğŸ’™" },
      { text: "Try to grab the remote back", points: -1, skill: "Physical Response", consequence: "Now you're fighting and someone might get hurt.", emoji: "ğŸŸ " },
      { text: "Scream 'I HATE YOU!' and hit them", points: -2, skill: "Aggression", consequence: "You're in big trouble. Hitting is never okay.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'e15', title: "The Bedtime Worry", timeOfDay: "ğŸŒ™ Evening", timeOrder: 12,
    situation: "You're in bed but can't sleep because you're worried about a test tomorrow.",
    choices: [
      { text: "Take deep breaths and tell yourself you'll do your best", points: 2, skill: "Self-Calming", consequence: "Your body relaxes and you fall asleep. You feel better in the morning!", emoji: "ğŸ’š" },
      { text: "Tell a parent you're worried so they can help", points: 1, skill: "Seeking Comfort", consequence: "They reassure you and maybe help you review quickly. You feel calmer.", emoji: "ğŸ’™" },
      { text: "Keep worrying and can't fall asleep for hours", points: -1, skill: "Rumination", consequence: "You're tired the next day, which makes the test harder.", emoji: "ğŸŸ " },
      { text: "Get out of bed and refuse to go to sleep at all", points: -2, skill: "Defiance", consequence: "You're exhausted tomorrow and in trouble for not sleeping.", emoji: "ğŸ”´" }
    ]
  }
];

const middleSchoolScenarios = [
  {
    id: 'm1', title: "The Social Media Morning", timeOfDay: "ğŸŒ… Morning at Home", timeOrder: 1,
    situation: "You check your phone and see your friends hung out last night without you. They posted pictures and didn't invite you.",
    choices: [
      { text: "Text a friend: 'Looked fun! What did you guys do?'", points: 2, skill: "Direct Communication", consequence: "They explain it was last minute. They promise to text you next time!", emoji: "ğŸ’š" },
      { text: "Put the phone down and focus on getting ready", points: 1, skill: "Emotional Regulation", consequence: "You don't start your day upset. At school, you ask casually and it wasn't personal.", emoji: "ğŸ’™" },
      { text: "Post something passive-aggressive on your story", points: -1, skill: "Passive-Aggression", consequence: "Your friends see it and feel confused. Now there's actual drama.", emoji: "ğŸŸ " },
      { text: "Send angry texts calling them fake friends", points: -2, skill: "Reactive Aggression", consequence: "A small thing that could've been explained turns into a real conflict.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm2', title: "The Outfit Crisis", timeOfDay: "ğŸŒ… Morning at Home", timeOrder: 1,
    situation: "Your favorite shirt is in the laundry. Nothing else feels right and you're running low on time.",
    choices: [
      { text: "Pick something elseâ€”clothes don't define you", points: 2, skill: "Flexibility", consequence: "You head out on time. Nobody even notices. You were overthinking it.", emoji: "ğŸ’š" },
      { text: "Ask if someone can throw it in the dryer quickly", points: 1, skill: "Problem-Solving", consequence: "It's a bit damp but wearable. You made it work!", emoji: "ğŸ’™" },
      { text: "Spend 20 minutes trying on everything while complaining", points: -1, skill: "Perfectionism", consequence: "You're late and stressed. Your whole morning is ruined.", emoji: "ğŸŸ " },
      { text: "Refuse to go to school because you have 'nothing to wear'", points: -2, skill: "Avoidance", consequence: "Missing school over clothes creates bigger problems.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm3', title: "The Locker Jam", timeOfDay: "ğŸšª Arrival", timeOrder: 2,
    situation: "Your locker is jammed and won't open. The warning bell just rang and you need your stuff.",
    choices: [
      { text: "Ask a nearby teacher for help", points: 2, skill: "Help-Seeking", consequence: "An adult helps and gives you a pass. Smart move!", emoji: "ğŸ’š" },
      { text: "Go to class and explainâ€”get your stuff later", points: 1, skill: "Flexibility", consequence: "Your teacher understands. No big deal!", emoji: "ğŸ’™" },
      { text: "Keep yanking on it harder while panicking", points: -1, skill: "Frustration", consequence: "You're late, sweaty, and stressed. Still stuck.", emoji: "ğŸŸ " },
      { text: "Kick the locker and yell", points: -2, skill: "Outburst", consequence: "A teacher sees and you get written up. Still stuck AND in trouble.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm4', title: "The Pop Quiz", timeOfDay: "ğŸ“š 1st Period", timeOrder: 3,
    situation: "Surprise quiz on reading you didn't finish. Your heart sinks.",
    choices: [
      { text: "Do your best and commit to doing the reading tonight", points: 2, skill: "Accountability", consequence: "You answer what you can. You learn and do better next time.", emoji: "ğŸ’š" },
      { text: "Try to remember what was discussed in class", points: 1, skill: "Resourcefulness", consequence: "You piece together enough. It's not great but honest.", emoji: "ğŸ’™" },
      { text: "Try to sneak looks at your neighbor's paper", points: -1, skill: "Cheating", consequence: "You're stressed the whole time about getting caught.", emoji: "ğŸŸ " },
      { text: "Complain loudly that pop quizzes are unfair", points: -2, skill: "Defiance", consequence: "The teacher gives you a zero. Your protest changed nothing.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm5', title: "The Partner Assignment", timeOfDay: "ğŸ“– 2nd Period", timeOrder: 4,
    situation: "You get paired with someone quiet and different from your usual friends.",
    choices: [
      { text: "Introduce yourself and ask what they're good at", points: 2, skill: "Inclusive Leadership", consequence: "They have great ideas! You work really well together.", emoji: "ğŸ’š" },
      { text: "Be friendly and do your fair share", points: 1, skill: "Cooperation", consequence: "Fine partnership. You get the work done well.", emoji: "ğŸ’™" },
      { text: "Do most of the work assuming they won't help", points: -1, skill: "Prejudgment", consequence: "You do way more work. They had good ideas you never heard.", emoji: "ğŸŸ " },
      { text: "Ask the teacher loudly if you can switch partners", points: -2, skill: "Public Rejection", consequence: "Your partner hears and feels terrible. Teacher says no.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm6', title: "The Gossip Circle", timeOfDay: "ğŸ¥¤ Nutrition Break", timeOrder: 5,
    situation: "Your friends are talking badly about another kid. They ask if you heard about what happened.",
    choices: [
      { text: "'I don't want to talk about them when they're not here'", points: 2, skill: "Moral Courage", consequence: "Awkward for a second, then everyone moves on. You feel good.", emoji: "ğŸ’š" },
      { text: "Don't add anything negative but stay quiet", points: 1, skill: "Non-Participation", consequence: "You don't make it worse. You wish you'd said something.", emoji: "ğŸ’™" },
      { text: "Add your own story to fit in", points: -1, skill: "Conformity", consequence: "You feel gross afterward. You said things you didn't mean.", emoji: "ğŸŸ " },
      { text: "Jump in with something really mean to make everyone laugh", points: -2, skill: "Cruelty", consequence: "Word gets back to the other kid. You've really hurt someone.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm7', title: "The Wrong Answer", timeOfDay: "ğŸŒ 3rd Period", timeOrder: 6,
    situation: "You confidently answer a question and the teacher says you're wrong. Kids snicker.",
    choices: [
      { text: "'Oh, what's the right answer? I want to understand.'", points: 2, skill: "Growth Mindset", consequence: "You actually learn something. The snickers stop.", emoji: "ğŸ’š" },
      { text: "Shrug it offâ€”everyone gets stuff wrong sometimes", points: 1, skill: "Self-Compassion", consequence: "You move on. By next class, nobody remembers.", emoji: "ğŸ’™" },
      { text: "Stop participating to avoid being wrong again", points: -1, skill: "Withdrawal", consequence: "You miss chances to learn. Playing it safe means missing out.", emoji: "ğŸŸ " },
      { text: "Mutter 'This class is dumb' and put your head down", points: -2, skill: "Defensive Shutdown", consequence: "The teacher notices. Your embarrassment became disrespect.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm8', title: "The Cafeteria Choice", timeOfDay: "ğŸ• Lunch", timeOrder: 7,
    situation: "You see a kid from your class sitting alone. Your table is full of conversation.",
    choices: [
      { text: "Invite them to join your table or sit with them", points: 2, skill: "Active Inclusion", consequence: "They're grateful. They're actually interesting! Friends think it was cool.", emoji: "ğŸ’š" },
      { text: "Wave and say hi when you walk by", points: 1, skill: "Acknowledgment", consequence: "A small gesture but it matters. They smile back.", emoji: "ğŸ’™" },
      { text: "Feel bad but sit with friends without acknowledging them", points: -1, skill: "Bystander", consequence: "You feel guilty. You know you could have done something kind.", emoji: "ğŸŸ " },
      { text: "Make a comment to friends about why they're alone", points: -2, skill: "Cruelty", consequence: "You've made someone's bad day worse.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm9', title: "The Tryout Results", timeOfDay: "ğŸ 4th Period", timeOrder: 8,
    situation: "You didn't make the team. You really wanted this and some friends made it.",
    choices: [
      { text: "Congratulate friends and ask coach what to work on", points: 2, skill: "Graceful Acceptance", consequence: "Coach gives helpful feedback. Friends respect how you handled it.", emoji: "ğŸ’š" },
      { text: "Take time to be disappointed, then think about what else to try", points: 1, skill: "Processing", consequence: "You're sad but start looking at other activities.", emoji: "ğŸ’™" },
      { text: "Tell everyone the tryouts were rigged", points: -1, skill: "Blame", consequence: "It feels better to blame others, but it doesn't help you improve.", emoji: "ğŸŸ " },
      { text: "Give friends the cold shoulder because they made it", points: -2, skill: "Jealousy", consequence: "You lose your team spot AND strain friendships.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm10', title: "The Group Text Drama", timeOfDay: "ğŸ“± Between Classes", timeOrder: 9,
    situation: "Heated argument in the group chat. People @ you asking whose side you're on.",
    choices: [
      { text: "Put phone away and respond later when things calm down", points: 2, skill: "Digital Boundaries", consequence: "By end of day, drama died down. You didn't add fuel.", emoji: "ğŸ’š" },
      { text: "'Can we not do this in chat? Talk in person.'", points: 1, skill: "Peacemaking", consequence: "Some agree, some ignore. You tried to de-escalate.", emoji: "ğŸ’™" },
      { text: "Pick a side and start defending them", points: -1, skill: "Drama Participation", consequence: "Now you're part of the fight.", emoji: "ğŸŸ " },
      { text: "Screenshot and send to people not in the chat", points: -2, skill: "Drama Spreading", consequence: "You spread private conflict. Your trustworthiness takes a hit.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm11', title: "The Overwhelm", timeOfDay: "ğŸ“ 5th Period", timeOrder: 10,
    situation: "Teacher explains a big project due next week. Combined with everything else, you feel overwhelmed.",
    choices: [
      { text: "Write everything down and plan to break it into pieces", points: 2, skill: "Organization", consequence: "Having it written makes it feel manageable.", emoji: "ğŸ’š" },
      { text: "Take deep breaths and tell yourself you'll figure it out", points: 1, skill: "Coping", consequence: "You calm your anxiety. Work's still there but you're not panicking.", emoji: "ğŸ’™" },
      { text: "Zone out because it's too much to handle", points: -1, skill: "Dissociation", consequence: "You miss important details. Now stressed AND confused.", emoji: "ğŸŸ " },
      { text: "Blurt out 'Are you kidding?! We have SO much work!'", points: -2, skill: "Outburst", consequence: "Teacher isn't impressed. Stress is valid, delivery got you in trouble.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm12', title: "The Bus Bullying", timeOfDay: "ğŸšŒ End of Day", timeOrder: 11,
    situation: "On the bus, kids in back are making fun of a younger student. Others are laughing.",
    choices: [
      { text: "Go sit near them or invite them to sit with you", points: 2, skill: "Active Protection", consequence: "They look relieved. Bullies lose audience. You did the right thing.", emoji: "ğŸ’š" },
      { text: "Tell the bus driver what's happening", points: 1, skill: "Appropriate Reporting", consequence: "Bus driver handles it. You helped without confrontation.", emoji: "ğŸ’™" },
      { text: "Turn up your music and pretend you don't notice", points: -1, skill: "Bystander", consequence: "They're still being bullied. You could have helped.", emoji: "ğŸŸ " },
      { text: "Laugh along even though you know it's wrong", points: -2, skill: "Joining In", consequence: "You're now part of the problem.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm13', title: "The Screen Time Battle", timeOfDay: "ğŸ  After School", timeOrder: 12,
    situation: "You've been on your phone a while. Parent says put it down for homework, but you're in the middle of something.",
    choices: [
      { text: "'Can I have 5 more minutes to finish this, then I'll start?'", points: 2, skill: "Negotiation", consequence: "Parent agrees. You finish up and do homework. Everyone's happy.", emoji: "ğŸ’š" },
      { text: "Sigh but put it downâ€”they're probably right", points: 1, skill: "Compliance", consequence: "Annoying but you get homework done. Evening goes smoothly.", emoji: "ğŸ’™" },
      { text: "Say 'In a minute' and keep scrolling", points: -1, skill: "Dismissive Delay", consequence: "They don't forget. Now they're more frustrated.", emoji: "ğŸŸ " },
      { text: "Yell 'You're always nagging me!' and storm off", points: -2, skill: "Escalation", consequence: "Real conflict. Might lose phone entirely.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm14', title: "The Friendship Tension", timeOfDay: "ğŸ“± Evening", timeOrder: 12,
    situation: "Friend texts asking if you're mad at them. You're notâ€”just been stressed and distant.",
    choices: [
      { text: "Call and explain you've been stressed, not about them", points: 2, skill: "Honest Communication", consequence: "They understand and offer to help. Friendship feels stronger.", emoji: "ğŸ’š" },
      { text: "'Not mad! Just busy with school. Hang out this weekend?'", points: 1, skill: "Reassurance", consequence: "They seem relieved. You make plans.", emoji: "ğŸ’™" },
      { text: "Text back 'No, why?' and leave it at that", points: -1, skill: "Dismissive Response", consequence: "Short answer doesn't reassure them. Weird energy continues.", emoji: "ğŸŸ " },
      { text: "Don't respondâ€”you don't want to deal with it", points: -2, skill: "Avoidance", consequence: "Not responding makes them think you ARE mad.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'm15', title: "The Bedtime Spiral", timeOfDay: "ğŸŒ™ Evening", timeOrder: 13,
    situation: "Trying to sleep but your mind keeps replaying an awkward thing you said today.",
    choices: [
      { text: "Remind yourself everyone has awkward moments and tomorrow is new", points: 2, skill: "Self-Compassion", consequence: "The thought fades. Morning comes and nobody remembers.", emoji: "ğŸ’š" },
      { text: "Do breathing exercises until your mind settles", points: 1, skill: "Distraction Technique", consequence: "Takes time but you eventually fall asleep.", emoji: "ğŸ’™" },
      { text: "Keep replaying it, imagining everyone thinks you're weird", points: -1, skill: "Rumination", consequence: "You barely sleep. You made the moment much bigger than it was.", emoji: "ğŸŸ " },
      { text: "Send an apologetic text at midnight trying to fix it", points: -2, skill: "Impulsive Overcorrection", consequence: "A weird midnight text makes things MORE awkward.", emoji: "ğŸ”´" }
    ]
  }
];

// Recurring characters in the HS story arc:
// Coach Reyes (your coach), Destiny (best friend), Marcus (hothead teammate/rival),
// Jordan (friend who struggles), Tyler (pressure figure), Dr. Okafor (school counselor)

const highSchoolScenarios = [
  {
    id: 'h1', title: "Game Day Morning", timeOfDay: "ğŸŒ… Morning", timeOrder: 1,
    situation: "It's the day of the biggest game of the season â€” and your alarm didn't go off. You have 20 minutes before the team bus leaves. Your phone shows 14 notifications, including a text from Coach Reyes: 'Everyone on time today. No exceptions.'",
    choices: [
      { text: "Throw on your gear, text Coach you're coming, skip breakfast â€” just get there", points: 2, skill: "Prioritization Under Pressure", consequence: "You make it with two minutes to spare. Coach gives you a look but nods. You're ready. The recruiter in the stands tonight doesn't know how close it was.", emoji: "ğŸ’š" },
      { text: "Wake up your parent, get a quick ride and a granola bar, cut it close", points: 1, skill: "Adaptive Recovery", consequence: "You arrive frazzled but present. Coach raises an eyebrow. You channel the adrenaline into warm-ups.", emoji: "ğŸ’™" },
      { text: "Panic-scroll notifications for 10 minutes before you even get up", points: -1, skill: "Distraction Over Action", consequence: "You're late. The team had to hold the bus. Coach doesn't yell â€” the silence is worse. The tension follows you onto the court.", emoji: "ğŸŸ " },
      { text: "Text your parent to call you in sick â€” the pressure is too much today", points: -2, skill: "Avoidance of High Stakes", consequence: "You miss the game. The scholarship recruiter was in the stands. When Destiny texts 'Where are you??', you don't know what to say.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h2', title: "The College Notification", timeOfDay: "ğŸŒ… Morning", timeOrder: 1,
    situation: "You check your email before school and see the subject line: 'Your Application Decision from Westfield University.' Your hands are shaking a little. You've wanted this school since 9th grade. You open it. It's a rejection.",
    choices: [
      { text: "Take 5 minutes to feel it fully, then text Destiny: 'Didn't get in. Can we talk at lunch?'", points: 2, skill: "Emotional Processing + Help-Seeking", consequence: "By lunch, you've cried a little, laughed a little, and made a plan. Destiny reminds you of two other schools you actually loved. The door closed â€” others are open.", emoji: "ğŸ’š" },
      { text: "Close the email, focus on getting to school, let yourself feel it tonight", points: 1, skill: "Healthy Compartmentalization", consequence: "You hold it together through the day. It hits harder at night, but you're in a better place to process it then. Dr. Okafor catches your eye in the hall and you make a mental note to stop by.", emoji: "ğŸ’™" },
      { text: "Spiral for an hour reading rejection story threads on Reddit before school", points: -1, skill: "Rumination", consequence: "You arrive late, red-eyed and mentally exhausted. The school day feels like noise.", emoji: "ğŸŸ " },
      { text: "Post a bitter story tagging the school: 'Their loss. System is rigged anyway.'", points: -2, skill: "Reactive Oversharing", consequence: "Screenshots circulate by homeroom. Teachers ask if you're okay. The attention makes it worse, not better.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h3', title: "The Hallway Call-Out", timeOfDay: "ğŸ« Arrival", timeOrder: 2, isTricky: true,
    situation: "Walking into school, you cross paths with Marcus â€” from your rival team â€” who's here for a joint athletic meeting. He spots you in front of a crowd and says loudly: 'Hope your game shows up tonight. Last time was embarrassing for you.'",
    choices: [
      { text: "'Game's tonight. I'll let my play talk.' Keep walking.", points: 2, skill: "Composed Confidence", consequence: "The crowd goes quiet â€” in a good way. Marcus looks annoyed he didn't get a reaction. You've already moved on. He hasn't.", emoji: "ğŸ’š" },
      { text: "Ignore him completely and walk past without breaking stride", points: 1, skill: "Strategic Non-Engagement", consequence: "You don't give him anything. A few people catch your eye and nod. Smart.", emoji: "ğŸ’™" },
      { text: "Clap back with something about his team's record in front of everyone", points: -1, skill: "Reactive Trash Talk", consequence: "The crowd reacts, but you're fired up in the wrong way for the next 3 hours. Marcus won exactly what he wanted.", emoji: "ğŸŸ " },
      { text: "Get in his face â€” security has to step between you", points: -2, skill: "Physical Escalation", consequence: "You're both pulled aside. Now you're worried about suspension on game day. Coach Reyes gets a call. The recruiter might hear.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h4', title: "The History Test", timeOfDay: "ğŸ“š 1st Period", timeOrder: 3,
    situation: "You sit down for the history test you've been dreading. You got back late from last night's away game and barely studied. The person next to you shifts their paper slightly in your direction â€” not an accident.",
    choices: [
      { text: "Cover your own paper, focus on what you actually know, leave the rest blank", points: 2, skill: "Academic Integrity", consequence: "You don't ace it. But every answer is yours. The grade stings less than you expected â€” there's something clean about it.", emoji: "ğŸ’š" },
      { text: "Look away from their paper and pull together what you studied and discussed in class", points: 1, skill: "Resourcefulness Under Pressure", consequence: "You piece together enough. Not your best work, but honest work.", emoji: "ğŸ’™" },
      { text: "Glance at their answers for the questions you've completely blanked on", points: -1, skill: "Academic Dishonesty", consequence: "You feel watched the entire period. The anxiety burns more energy than the answers saved.", emoji: "ğŸŸ " },
      { text: "Photograph their paper with your phone under the desk", points: -2, skill: "Serious Academic Misconduct", consequence: "The teacher notices. You're called out after class. This goes on your record â€” the kind that follows college applications.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h5', title: "The AP Essay Crisis", timeOfDay: "ğŸ“– 2nd Period", timeOrder: 4,
    situation: "Your AP Lit teacher announces the essay due today cannot be pushed â€” it's 25% of your grade. You forgot. Between practice, the game, and the college stuff, it completely slipped. You have zero words written.",
    choices: [
      { text: "Go to the teacher before class ends, explain honestly, and ask for a makeup plan", points: 2, skill: "Assertive Self-Advocacy", consequence: "The teacher respects your honesty. You get a 72 with a late penalty â€” not great, but real. You leave with a plan and your dignity intact.", emoji: "ğŸ’š" },
      { text: "Write as fast as you can during passing periods and lunch, submit whatever you have", points: 1, skill: "Resilient Problem-Solving", consequence: "It's scrambled and short. But partial credit beats a zero, and your teacher sees the effort.", emoji: "ğŸ’™" },
      { text: "Submit an essay you find online with a few words changed", points: -1, skill: "Plagiarism", consequence: "Turnitin flags it immediately. Now it's a zero AND an academic integrity report. The essay became the least of your problems.", emoji: "ğŸŸ " },
      { text: "Skip class entirely to avoid the confrontation", points: -2, skill: "Conflict Avoidance", consequence: "Unexcused absence + automatic zero. Your GPA takes a serious hit right when college apps need it most.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h6', title: "The Locker Room Offer", timeOfDay: "ğŸƒ Pre-Practice", timeOrder: 5, isTricky: true,
    situation: "Before warm-ups, Tyler pulls you aside in the locker room. 'Take the edge off before the game, bro. Everyone does it.' He holds out a small pill. You have no idea what it is. The game is in four hours.",
    choices: [
      { text: "'Nah, I'm good. I need my head clear tonight.' Walk straight to the gym.", points: 2, skill: "Confident Refusal", consequence: "Tyler shrugs. You feel clear-headed going into warm-ups. Coach Reyes pulls you aside: 'You look focused today.' You are.", emoji: "ğŸ’š" },
      { text: "Shake your head, say you're drug-tested for recruitment, and leave", points: 1, skill: "Face-Saving Refusal", consequence: "He accepts it. Not fully honest, but you got out clean. You wonder if Tyler's doing okay.", emoji: "ğŸ’™" },
      { text: "Take it without asking what it is â€” you don't want to look scared", points: -1, skill: "Uninformed Compliance", consequence: "You feel off during warm-ups. Sluggish and disconnected. Coach notices something. You don't tell anyone what happened.", emoji: "ğŸŸ " },
      { text: "Take it and tell Tyler to save more for after the game", points: -2, skill: "Escalating Risk-Taking", consequence: "Your performance is visibly impaired. Coach benches you. Destiny texts from the stands: 'Is everything okay??' You don't answer.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h7', title: "The Team Group Chat", timeOfDay: "ğŸ“± Between Classes", timeOrder: 5,
    situation: "The team group chat explodes. Marcus is calling out Devon â€” another teammate â€” saying Devon's responsible for last game's loss. People are picking sides and @-ing you specifically. 'You were there â€” say something.'",
    choices: [
      { text: "'This isn't the place for this. Save it for practice.' Mute the chat.", points: 2, skill: "Digital Leadership", consequence: "A few teammates react positively. The chat simmers. Devon texts you privately: 'Thanks for not piling on.' That matters.", emoji: "ğŸ’š" },
      { text: "Mute the chat, say nothing publicly, check in with Devon in person later", points: 1, skill: "Thoughtful Restraint", consequence: "You stay out of it. Devon appreciates that you didn't join the pile. The drama burns out on its own by practice.", emoji: "ğŸ’™" },
      { text: "Jump in, pick a side, start defending them publicly in the chat", points: -1, skill: "Drama Participation", consequence: "Now you're part of it. The team atmosphere at practice is tense. Coach Reyes notices and makes everyone run extra.", emoji: "ğŸŸ " },
      { text: "Screenshot the thread and share it outside the team group", points: -2, skill: "Trust Violation", consequence: "Devon finds out. So does Coach. A mandatory team meeting gets called. Your name is in the middle of it all.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h8', title: "The Starting Lineup", timeOfDay: "ğŸ† Game Day", timeOrder: 6,
    situation: "Coach Reyes posts the starting lineup for tonight. You check it during passing period. You're not in it. A sophomore â€” someone who just joined the program â€” is starting in your spot. A scholarship recruiter is going to be watching tonight.",
    choices: [
      { text: "Go see Coach privately after school: 'What do I need to work on to earn that back?'", points: 2, skill: "Accountable Growth Mindset", consequence: "Coach tells you exactly what they saw in film. You come off the bench and play the best 12 minutes of your season. The recruiter takes note.", emoji: "ğŸ’š" },
      { text: "Take a breath, feel the disappointment privately, then decide to prove it on the court", points: 1, skill: "Emotional Regulation + Motivation", consequence: "Your backup minutes are some of your best this season. You're not happy â€” but you're not broken either.", emoji: "ğŸ’™" },
      { text: "Text the team group chat: 'This lineup doesn't make sense. Everyone knows it.'", points: -1, skill: "Reactive Undermining", consequence: "Word gets back to Coach. Your attitude becomes the story, not your skill. The recruiter hears about the drama.", emoji: "ğŸŸ " },
      { text: "Confront Coach in front of the team during the pre-game meeting", points: -2, skill: "Public Insubordination", consequence: "Coach sits you for the entire game. The recruiter watches you spend the night at the end of the bench. This was the wrong hill to die on.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h9', title: "The Cafeteria Moment", timeOfDay: "ğŸ• Lunch", timeOrder: 7,
    situation: "You're eating lunch with Destiny when you both notice Jordan â€” a kid from your AP class â€” sitting completely alone at the end of a table, staring at their phone. You heard Jordan tell a teacher last week they were 'going through a lot at home.' Jordan looks up, sees you, then looks back down.",
    choices: [
      { text: "Grab your tray and go sit near Jordan. 'Hey â€” you can sit with us if you want.'", points: 2, skill: "Active Empathy", consequence: "Jordan looks genuinely relieved. You don't have to say much. Destiny keeps the conversation light. Sometimes just not being alone is everything.", emoji: "ğŸ’š" },
      { text: "Make eye contact across the room and give a small nod or wave", points: 1, skill: "Acknowledgment", consequence: "It's a small thing, but it's real. Jordan's posture softens. You make a note to check in after class.", emoji: "ğŸ’™" },
      { text: "Feel bad about it, but stay in your conversation and tell yourself Jordan probably wants space", points: -1, skill: "Bystander Rationalization", consequence: "You know it wasn't your best moment. That feeling sticks with you through 5th period.", emoji: "ğŸŸ " },
      { text: "Make a comment to Destiny about why Jordan is always alone", points: -2, skill: "Unkindness", consequence: "Someone at your table knows Jordan well. It gets back. You made a hard situation worse.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h10', title: "The Scholarship Call", timeOfDay: "ğŸ“ 4th Period", timeOrder: 8,
    situation: "Dr. Okafor pulls you out of a free period. A D2 athletic program called â€” they're offering a partial scholarship, but they need to know your interest level by Friday. You hadn't considered this school at all. Your parents have always said D1 or nothing.",
    choices: [
      { text: "'Can I have 48 hours to research the program and talk to my family?' Request more time.", points: 2, skill: "Informed Decision-Making", consequence: "Dr. Okafor says yes. You do your homework. The conversation with your parents is hard and honest. You end up with a real answer â€” not a reflexive one.", emoji: "ğŸ’š" },
      { text: "Ask Dr. Okafor to email you all the details so you can review everything first", points: 1, skill: "Information-Seeking", consequence: "Smart move. You have real information before emotion takes over. You'll process this tonight with a clear head.", emoji: "ğŸ’™" },
      { text: "Say you're not interested right away â€” it's not D1, so why even bother", points: -1, skill: "Premature Foreclosure", consequence: "You close a door before you know what's behind it. Dr. Okafor looks concerned but doesn't push. You wonder about it for weeks.", emoji: "ğŸŸ " },
      { text: "Reject it immediately because your parents would disapprove if they found out you considered it", points: -2, skill: "People-Pleasing Over Self-Advocacy", consequence: "You never figure out what YOU actually want. Years later, you'll wonder what might have been if you'd asked more questions.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h11', title: "Jordan's Story", timeOfDay: "ğŸ“± Between Classes", timeOrder: 9,
    situation: "Destiny texts you: 'Did you see what Jordan posted?' You open it. Jordan's story just says: 'maybe some people just aren't meant to be here.' No context. No follow-up. You have class in 4 minutes.",
    choices: [
      { text: "Call Jordan right now, even if it means being late to class. 'Hey â€” I saw your story. I'm worried about you. Can we talk?'", points: 2, skill: "Crisis Response + Active Care", consequence: "Jordan picks up. Their voice is shaky. You listen. By the end of passing period, you've walked them to Dr. Okafor's office. This was the most important thing you did today.", emoji: "ğŸ’š" },
      { text: "Text Jordan directly: 'I saw your story. You okay? I'm here whenever you need.' Then tell a trusted adult.", points: 1, skill: "Proactive Support", consequence: "Jordan responds eventually. It opens a door. Telling a counselor was the right call â€” they check in too. Jordan isn't alone.", emoji: "ğŸ’™" },
      { text: "Forward the story to your friend group asking 'is this okay??' before doing anything else", points: -1, skill: "Gossip Over Action", consequence: "Now it's spreading. No adult knows. Jordan sees people whispering and feels exposed â€” not supported.", emoji: "ğŸŸ " },
      { text: "Assume it's vague-posting for attention and keep walking to class", points: -2, skill: "Dismissal of Warning Signs", consequence: "Jordan needed someone to notice and take it seriously. Nobody did. They spend the afternoon alone, feeling invisible.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h12', title: "Before the Game", timeOfDay: "ğŸ« After School", timeOrder: 10, isTricky: true,
    situation: "Two hours before tip-off, your partner texts: 'You missed my performance AGAIN last weekend and now you won't even talk about it. We need to talk RIGHT NOW.' You care about them. But you also need to focus. Tonight matters.",
    choices: [
      { text: "'I hear you and I want to talk â€” not in a text. Can we connect right after the game? This conversation deserves my full attention.'", points: 2, skill: "Assertive Boundary + Emotional Care", consequence: "They're hurt but they respect it. After the game, you actually have the conversation â€” with space and honesty. You don't lose either the game or the relationship.", emoji: "ğŸ’š" },
      { text: "Call them quickly â€” listen, validate that you've been absent, ask for a little time to get through tonight", points: 1, skill: "Active Listening + Honesty", consequence: "The call is short but genuine. They don't love it, but they feel heard. You go in with a clearer head.", emoji: "ğŸ’™" },
      { text: "Text back: 'I can't believe you're doing this right now' and shut your phone off", points: -1, skill: "Defensive Avoidance", consequence: "You both stew. You play distracted. The relationship and the game both suffer.", emoji: "ğŸŸ " },
      { text: "Leave the texts on read and deal with it after â€” they'll understand once you win", points: -2, skill: "Avoidance + Assumption", consequence: "They spiral all night. You play distracted. When you finally reach out, 'I was busy' doesn't land the way you hoped.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h13', title: "After the Final Buzzer", timeOfDay: "ğŸŒ† Evening", timeOrder: 11,
    situation: "The game is over. Win or lose, the team is heading to a party at Marcus's place. There's alcohol everywhere. Coach Reyes's only rule: no drinking before school or games. You notice a girl across the room who's had way too much â€” her friends are gone and she looks unsteady.",
    choices: [
      { text: "Stay sober and make sure she has a safe way home â€” call her a ride or find someone she trusts", points: 2, skill: "Moral Courage + Active Care", consequence: "She's safe. You find out her name the next day. She thanks you. You don't even need recognition â€” you made the right call and you know it.", emoji: "ğŸ’š" },
      { text: "Get a trusted friend to help, call her an Uber together, make sure she's okay before you leave", points: 1, skill: "Collaborative Responsibility", consequence: "She gets home safe. You both feel good about that. It didn't ruin your night â€” it defined it.", emoji: "ğŸ’™" },
      { text: "Notice it, feel uncomfortable, assume someone else will step in", points: -1, skill: "Bystander Effect", consequence: "Nobody else steps in either. The next day there are rumors about what happened. You know you could have done something. That feeling doesn't go away fast.", emoji: "ğŸŸ " },
      { text: "Take videos of her and post them to your story", points: -2, skill: "Exploitation", consequence: "You filmed someone vulnerable without consent. What follows â€” socially and potentially legally â€” is serious. This is one of those moments you can't take back.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h14', title: "The Cover Story", timeOfDay: "ğŸ  After School", timeOrder: 12,
    situation: "Tyler texts you the next morning: 'Marcus is going to tell Coach what happened at the party. I told him something in confidence and now it's going to blow up. Just say I was with you all night â€” Coach won't question it if it comes from you.'",
    choices: [
      { text: "'I can't lie to Coach for you. But let's talk about how to handle this honestly before it gets worse.'", points: 2, skill: "Integrity + Loyal Honesty", consequence: "Tyler is frustrated, but you didn't compromise yourself. The truth comes out anyway â€” it usually does. Your integrity stays intact and Coach notices that.", emoji: "ğŸ’š" },
      { text: "'I won't lie, but I won't bring it up unless Coach asks me directly either.' Set that limit.", points: 1, skill: "Principled Boundary", consequence: "Fair and honest. You protect yourself without throwing Tyler overboard. It's not a perfect solution but it's a real one.", emoji: "ğŸ’™" },
      { text: "Agree to back up Tyler's story â€” he'd do it for you, right?", points: -1, skill: "Complicity", consequence: "You're now inside the cover-up. Coach doesn't fully believe anyone. You spend the next week worried you'll be the one called in.", emoji: "ğŸŸ " },
      { text: "Agree to lie, then panic when Coach asks you directly and tell a different story", points: -2, skill: "Compounding Dishonesty", consequence: "Now nobody trusts you â€” not Tyler, not Coach, not your teammates. You tried to protect everyone and ended up hurting everyone, including yourself.", emoji: "ğŸ”´" }
    ]
  },
  {
    id: 'h15', title: "The Night Spiral", timeOfDay: "ğŸŒ™ Night", timeOrder: 13,
    situation: "It's 11 PM. College app due in 3 days. Six texts you haven't answered. Grades slipping in two APs. You're lying in bed staring at the ceiling, and a thought creeps in: what if none of this effort actually matters? What if you're not enough? The thought sits there, heavier than it should.",
    choices: [
      { text: "Open your notes app. Write one true thing that was good today. Write one thing you can actually do tomorrow. Close everything else.", points: 2, skill: "Grounding + Action Planning", consequence: "The spiral slows. You can't fix everything tonight â€” but you don't have to. You sleep. Tomorrow you can start. That's enough.", emoji: "ğŸ’š" },
      { text: "Text Destiny: 'I'm deep in my head tonight. You up?' Let someone in.", points: 1, skill: "Vulnerability + Connection", consequence: "She's up. You talk. It's not fixed, but you feel less alone. Sleep comes eventually. That matters.", emoji: "ğŸ’™" },
      { text: "Keep scrolling until 2 AM hoping the noise drowns out the thoughts", points: -1, skill: "Avoidance through Distraction", consequence: "You wake exhausted and more behind. The thoughts are still there â€” they just waited.", emoji: "ğŸŸ " },
      { text: "Decide none of it matters â€” not the apps, not the game, not school â€” and let the thought get darker", points: -2, skill: "Catastrophic Thinking", consequence: "Thoughts get darker and harder to hold alone. This is the kind of night where reaching out matters more than anything else. Text or call 988 â€” someone will answer and they want to hear from you.", emoji: "ğŸ”´" }
    ]
  }
];

// ========== HELPER FUNCTIONS ==========

const shuffleArray = (arr) => {
  const shuffled = [...arr];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
};

const selectScenariosForDay = (scenarios, count) => {
  const byTime = {};
  scenarios.forEach(s => {
    if (!byTime[s.timeOrder]) byTime[s.timeOrder] = [];
    byTime[s.timeOrder].push(s);
  });
  const timeSlots = Object.keys(byTime).sort((a, b) => parseInt(a) - parseInt(b));
  const selected = [];
  let remaining = count;
  
  for (const slot of timeSlots) {
    if (remaining <= 0) break;
    const available = shuffleArray(byTime[slot]);
    const take = Math.min(1, remaining, available.length);
    selected.push(...available.slice(0, take));
    remaining -= take;
  }
  
  while (selected.length < count) {
    const remaining = scenarios.filter(s => !selected.includes(s));
    if (remaining.length === 0) break;
    selected.push(shuffleArray(remaining)[0]);
  }
  
  return selected.sort((a, b) => a.timeOrder - b.timeOrder).slice(0, count);
};

const getStressModifiedScenario = (scenario, stress, calm, flags = []) => {
  const s = { ...scenario };
  if (stress >= 6) {
    s.stressModifier = { active: true, prefix: "You're already feeling on edge. ", effect: "Your stress is high, making this harder." };
    s.situation = s.stressModifier.prefix + s.situation;
  }
  if (stress >= 9) {
    s.stressModifier = { active: true, prefix: "Everything feels overwhelming right now. ", effect: "Your stress is very high. Hard to think clearly." };
    s.situation = s.stressModifier.prefix + s.situation;
  }
  if (calm >= 7 && stress < 6) {
    s.wellbeingModifier = { active: true, prefix: "Things have been going well lately. ", effect: "Your calm energy helps you handle this." };
    s.situation = s.wellbeingModifier.prefix + s.situation;
  }
  return s;
};

const getModifiedConsequence = (choice, stress) => {
  let consequence = choice.consequence;
  let bonusPoints = 0;
  let stressChange = 0;
  let calmChange = 0;

  if (choice.points === 2) {
    stressChange = -2; calmChange = 2;
    if (stress >= 6) { consequence += " Despite your stress, you handled this really well."; bonusPoints = 1; }
  } else if (choice.points === 1) {
    stressChange = -1; calmChange = 1;
  } else if (choice.points === -1) {
    stressChange = 2; calmChange = -1;
    if (stress >= 6) consequence += " Being stressed made this harder.";
  } else if (choice.points === -2) {
    stressChange = 3; calmChange = -2;
    if (stress >= 6) consequence += " Your built-up stress made this blow up even more.";
  }

  return { consequence, bonusPoints, stressChange, calmChange };
};

// ========== BADGES ==========

const BADGES = [
  {
    id: 'hot_streak',
    emoji: 'ğŸ”¥',
    name: 'On Fire',
    desc: '3 great choices in a row',
    check: (r, streak) => streak >= 3
  },
  {
    id: 'brave_heart',
    emoji: 'ğŸ¦',
    name: 'Brave Heart',
    desc: 'Chose integrity or courage when it was hard',
    check: (r) => r.some(x => x.points > 0 && [
      'Confident Refusal', 'Academic Integrity', 'Integrity', 'Moral Courage',
      'Principled Boundary', 'Accountable', 'Honesty', 'Composed Confidence'
    ].some(s => x.skill?.includes(s)))
  },
  {
    id: 'got_your_back',
    emoji: 'ğŸ¤',
    name: 'Got Your Back',
    desc: 'Went out of your way to support someone else',
    check: (r) => r.some(x => x.points > 0 && [
      'Active Empathy', 'Active Protection', 'Active Inclusion',
      'Crisis Response', 'Proactive Support', 'Collaborative Responsibility'
    ].some(s => x.skill?.includes(s)))
  },
  {
    id: 'cool_head',
    emoji: 'ğŸ§Š',
    name: 'Cool Head',
    desc: 'Made a strong choice when stress was high',
    check: (r) => r.some(x => x.points > 0 && (x.stressBefore ?? 0) >= 6)
  },
  {
    id: 'bounce_back',
    emoji: 'â¬†ï¸',
    name: 'Bounce Back',
    desc: 'Recovered with a great choice after a tough one',
    check: (r) => { for (let i = 1; i < r.length; i++) if (r[i-1].points < 0 && r[i].points > 0) return true; return false; }
  },
  {
    id: 'all_star',
    emoji: 'â­',
    name: 'All Star',
    desc: 'Positive choices on 75%+ of scenarios',
    check: (r) => r.length >= 3 && r.filter(x => x.points > 0).length / r.length >= 0.75
  },
  {
    id: 'voice',
    emoji: 'ğŸ’¬',
    name: 'Speaks Up',
    desc: 'Used clear communication when it really counted',
    check: (r) => r.filter(x => x.points > 0 && (
      x.skill?.toLowerCase().includes('communicat') ||
      x.skill?.toLowerCase().includes('asserti') ||
      x.skill?.toLowerCase().includes('advocacy') ||
      x.skill?.toLowerCase().includes('expressing')
    )).length >= 2
  }
];

// ========== DISCUSSION PROMPTS ==========

const DISCUSSION_PROMPTS = {
  // Elementary
  'e1':  "What are some ways people respond when they don't get what they want? What makes flexibility hard â€” and why does it matter?",
  'e2':  "When you're panicking, what happens in your body? What helps you slow down and think more clearly?",
  'e3':  "Have you ever felt like something 'belonged' to you that wasn't really yours? How do we share space with others?",
  'e4':  "What gets in the way of asking for help when you're confused? Why might asking actually help other people in the room too?",
  'e5':  "When someone in a group acts like they're in charge, what are different ways to respond? What does real teamwork actually look like?",
  'e6':  "What does it feel like to be left out? What options do we have when something we wanted isn't available to us?",
  'e7':  "Think of a time something embarrassing happened in front of others. What made it better or worse? How does laughing at yourself change things?",
  'e8':  "When you see someone who's really good at something you struggle with, what do you feel? What's the difference between giving up and growing?",
  'e9':  "What's the difference between being aggressive, passive, and assertive? Can you give an example of each from real life?",
  'e10': "Why is it sometimes hard to admit a mistake â€” especially when no one saw? What changes in a relationship when someone is honest?",
  'e11': "What do you say to yourself when something is physically hard? How does self-talk actually affect performance?",
  'e12': "When a friend hurts your feelings, what's the difference between expressing it and taking it out on them?",
  'e13': "Why do we sometimes avoid things we don't want to do? What usually happens when we keep putting something off?",
  'e14': "Think about a conflict at home. What responses tend to make it better? What tends to make it escalate?",
  'e15': "What kinds of worries keep you up at night? What's actually helped you feel calmer â€” and what made things worse?",
  // Middle School
  'm1':  "How does social media change the way we experience being left out? What's different about how it feels online vs. in person?",
  'm2':  "Why do we sometimes tie how we feel about ourselves to what we look like or wear? When does that become a real problem?",
  'm3':  "What does frustration feel like in your body? What strategies actually help â€” and what makes frustration worse?",
  'm4':  "What pressures push students toward cheating? Is the real cost the grade, the anxiety, or something else?",
  'm5':  "What assumptions do we make about people before we know them? How does prejudging others hurt everyone in the situation?",
  'm6':  "Why is it so hard to speak up when friends say something unkind? What does it cost us â€” and others â€” when we stay silent?",
  'm7':  "What do you usually do when you're embarrassed in front of others? What does healthy resilience look like after public mistakes?",
  'm8':  "What's the difference between noticing someone lonely and actually doing something about it? What gets in the way?",
  'm9':  "How do we handle disappointing results when our peers succeed and we don't? What's the line between healthy motivation and jealousy?",
  'm10': "Why does online conflict feel more urgent and intense than in-person conflict? What are the real consequences of reacting impulsively in a group chat?",
  'm11': "What does it feel like in your body when you're overwhelmed? What's the difference between expressing stress constructively and destructively?",
  'm12': "What makes bystanders so powerful â€” both when they do nothing AND when they act? What stops people from stepping in?",
  'm13': "What patterns lead to conflict about phone use at home? What negotiation skills could change the outcome?",
  'm14': "When we're stressed, why do our closest relationships often get the silent treatment? How does avoiding hard conversations make things worse?",
  'm15': "What is rumination, and why does our brain get stuck in it? What research-backed strategies actually help interrupt the cycle?",
  // High School
  'h1':  "What does it look like when high-stakes pressure meets poor preparation? How does avoidance in these moments affect both performance and trust?",
  'h2':  "How do we process rejection when a lot of our identity is tied to an outcome? What does healthy processing look like vs. letting it spiral?",
  'h3':  "Why do public call-outs trigger such strong reactions? What does it actually mean to 'win' when someone is trying to provoke you? Is there more than one right answer here?",
  'h4':  "What pressures push students toward academic dishonesty? Is the real cost the grade, the anxiety during it, or something else entirely?",
  'h5':  "What does real self-advocacy look like in an academic setting â€” especially when you're clearly in the wrong?",
  'h6':  "What makes it hard to say no in peer situations? What does confident refusal actually look like? Is there more than one valid way to refuse here?",
  'h7':  "How does digital conflict change group dynamics? What does leadership look like in a group chat vs. in person?",
  'h8':  "How do we respond when something we've worked hard for gets taken away? What's the difference between accountability and unfair treatment?",
  'h9':  "Why is it so easy to convince ourselves 'someone else will help'? What's the real cost of small acts of kindness we talk ourselves out of?",
  'h10': "How do family expectations shape the decisions we make for ourselves? What does it mean to make an informed decision vs. a reflexive one?",
  'h11': "What warning signs might indicate a peer is really struggling? When does concern for a friend cross into something that requires adult involvement?",
  'h12': "How do we balance responsibilities to multiple people simultaneously when stakes are high? All four choices here carry real costs â€” discuss them. Is any of them clearly wrong?",
  'h13': "What makes bystander situations complicated â€” even when the right thing seems obvious? What does moral courage actually cost in social settings?",
  'h14': "What's the difference between loyalty and complicity? Is there a way to be a loyal friend without compromising your own integrity?",
  'h15': "What does it look like when stress becomes something bigger and darker? How do we create cultures where asking for help feels normal rather than weak?"
};

// ========== BACKSTORY CHIP DATA ==========

const calmActivityChips = [
  { id: 'music',    label: 'Listening to music',       emoji: 'ğŸµ' },
  { id: 'sports',   label: 'Playing sports',           emoji: 'âš½' },
  { id: 'art',      label: 'Drawing or painting',      emoji: 'ğŸ¨' },
  { id: 'gaming',   label: 'Playing video games',      emoji: 'ğŸ®' },
  { id: 'outside',  label: 'Being outside',            emoji: 'ğŸŒ¿' },
  { id: 'cooking',  label: 'Cooking or baking',        emoji: 'ğŸ³' },
  { id: 'reading',  label: 'Reading',                  emoji: 'ğŸ“š' },
  { id: 'sleep',    label: 'Resting or napping',       emoji: 'ğŸ˜´' },
  { id: 'friends',  label: 'Hanging out with friends', emoji: 'ğŸ¤' },
  { id: 'pet',      label: 'Being with my pet',        emoji: 'ğŸ¶' },
  { id: 'journal',  label: 'Writing or journaling',    emoji: 'âœï¸' },
  { id: 'prayer',   label: 'Prayer or meditation',     emoji: 'ğŸ™' }
];

const supportPersonChips = [
  { id: 'mom',       label: 'My mom',                  emoji: 'ğŸ‘©' },
  { id: 'dad',       label: 'My dad',                  emoji: 'ğŸ‘¨' },
  { id: 'bestie',    label: 'My best friend',          emoji: 'ğŸ’›' },
  { id: 'sib',       label: 'A sibling',               emoji: 'ğŸ‘«' },
  { id: 'coach',     label: 'A coach or teacher',      emoji: 'ğŸ†' },
  { id: 'counselor', label: 'A school counselor',      emoji: 'ğŸ’¬' },
  { id: 'grandpa',   label: 'A grandparent',           emoji: 'ğŸ‘´' },
  { id: 'aunt',      label: 'An aunt or uncle',        emoji: 'ğŸ«‚'  },
  { id: 'therapist', label: 'A therapist',             emoji: 'ğŸŒ±' },
  { id: 'myself',    label: 'I process things alone',  emoji: 'ğŸ§ ' },
  { id: 'journal2',  label: 'My journal',              emoji: 'ğŸ““' },
  { id: 'community', label: 'An online community',     emoji: 'ğŸ’»' }
];

const proudMomentChips = [
  { id: 'grades',    label: 'Improved a grade',            emoji: 'ğŸ“ˆ' },
  { id: 'sport',     label: 'Achieved something in sports', emoji: 'ğŸ…' },
  { id: 'stood_up',  label: 'Stood up for someone',        emoji: 'ğŸ¦' },
  { id: 'helped',    label: 'Helped someone in need',      emoji: 'ğŸ¤²' },
  { id: 'finished',  label: 'Finished something hard',     emoji: 'âœ…' },
  { id: 'honest',    label: 'Was honest when it was tough', emoji: 'ğŸª' },
  { id: 'new',       label: 'Tried something new',         emoji: 'ğŸš€' },
  { id: 'boundary',  label: 'Set a boundary',              emoji: 'ğŸ›‘' },
  { id: 'team',      label: 'Was a good teammate',         emoji: 'ğŸ‘¥' },
  { id: 'learned',   label: 'Learned from a mistake',      emoji: 'ğŸ’¡' },
  { id: 'create',    label: 'Created something',           emoji: 'ğŸ¨' },
  { id: 'apology',   label: 'Apologized and meant it',     emoji: 'ğŸ’™' }
];

// ========== SVG AVATAR FACE COMPONENT ==========

const ACC_OPTS = {
  hair: [
    { id: 'none',  label: 'Bald',   icon: 'ğŸª®' },
    { id: 'short', label: 'Short',  icon: 'âœ‚ï¸' },
    { id: 'curly', label: 'Curly',  icon: 'ğŸŒ€' },
    { id: 'long',  label: 'Long',   icon: 'ğŸ’‡' },
    { id: 'bun',   label: 'Bun',    icon: 'ğŸª¡' },
    { id: 'bangs', label: 'Bangs',  icon: 'ã€°ï¸' }
  ],
  hat: [
    { id: 'none',        label: 'None',     icon: 'â€”' },
    { id: 'beanie',      label: 'Beanie',   icon: 'ğŸ§¢' },
    { id: 'cap',         label: 'Cap',      icon: 'ğŸ§¢' },
    { id: 'crown',       label: 'Crown',    icon: 'ğŸ‘‘' },
    { id: 'mortarboard', label: 'Grad Cap', icon: 'ğŸ“' }
  ],
  glasses: [
    { id: 'none',   label: 'None',   icon: 'â€”' },
    { id: 'round',  label: 'Round',  icon: 'ğŸ”µ' },
    { id: 'shades', label: 'Shades', icon: 'ğŸ˜' },
    { id: 'heart',  label: 'Heart',  icon: 'ğŸ’—' },
    { id: 'star',   label: 'Star',   icon: 'â­' }
  ],
  extra: [
    { id: 'none',      label: 'None',      icon: 'â€”' },
    { id: 'scarf',     label: 'Scarf',     icon: 'ğŸ§£' },
    { id: 'bow',       label: 'Bow Tie',   icon: 'ğŸ€' },
    { id: 'headband',  label: 'Headband',  icon: 'ğŸŒ¸' },
    { id: 'earrings',  label: 'Earrings',  icon: 'ğŸ’›' }
  ]
};

function AvatarFace({ stress = 2, calm = 5, accessories = {}, size = 100 }) {
  const YELLOW = '#FBBF24';
  const OUTLINE = '#92400e';

  let level;
  if (stress >= 9 || calm <= 2) level = -2;
  else if (stress >= 6)         level = -1;
  else if (calm >= 7 && stress < 4) level = 2;
  else if (calm >= 5 && stress < 6) level = 1;
  else level = 0;

  const { hair = 'none', hat = 'none', glasses = 'none', extra = 'none' } = accessories;
  const fade = (l) => ({ opacity: level === l ? 1 : 0, transition: 'opacity 0.4s ease' });

  // Hair colors
  const HC = { short: '#3D2B1F', curly: '#111111', long: '#5C3317', bun: '#8B4513', bangs: '#E8C84A' };

  // === BACK HAIR (rendered before face) ===
  const backHair = () => {
    if (hat !== 'none') return null;
    if (hair === 'long') return (
      <g>
        <rect x="4" y="22" width="13" height="80" rx="6" fill={HC.long} />
        <rect x="83" y="22" width="13" height="80" rx="6" fill={HC.long} />
      </g>
    );
    if (hair === 'curly') return (
      <g>
        <circle cx="50" cy="30" r="36" fill={HC.curly} />
        <circle cx="11" cy="48" r="17" fill={HC.curly} />
        <circle cx="89" cy="48" r="17" fill={HC.curly} />
        <circle cx="22" cy="20" r="12" fill="#222" />
        <circle cx="78" cy="20" r="12" fill="#222" />
        <circle cx="50" cy="12" r="13" fill="#1a1a1a" />
      </g>
    );
    return null;
  };

  // === FRONT HAIR (rendered after face, before hat) ===
  const frontHair = () => {
    if (hat !== 'none') return null;
    if (hair === 'short') return (
      <path d="M 10 57 Q 10 9 50 9 Q 90 9 90 57 Q 76 37 50 35 Q 24 37 10 57 Z" fill={HC.short} />
    );
    if (hair === 'long') return (
      <path d="M 10 57 Q 10 9 50 9 Q 90 9 90 57 Q 76 37 50 35 Q 24 37 10 57 Z" fill={HC.long} />
    );
    if (hair === 'bun') return (
      <g>
        <path d="M 18 57 Q 18 9 50 9 Q 82 9 82 57 Q 70 37 50 35 Q 30 37 18 57 Z" fill={HC.bun} />
        <circle cx="50" cy="3" r="13" fill={HC.bun} />
        <circle cx="50" cy="3" r="7" fill="#A0522D" />
        <line x1="44" y1="5" x2="56" y2="5" stroke={HC.bun} strokeWidth="2" />
        <line x1="50" y1="0" x2="50" y2="10" stroke="#A0522D" strokeWidth="1.5" />
      </g>
    );
    if (hair === 'bangs') return (
      <g>
        <path d="M 10 57 Q 10 9 50 9 Q 90 9 90 57 Q 76 37 50 35 Q 24 37 10 57 Z" fill={HC.bangs} />
        <rect x="11" y="37" width="78" height="11" rx="5" fill={HC.bangs} />
        <line x1="22" y1="42" x2="28" y2="48" stroke="rgba(0,0,0,0.12)" strokeWidth="1.5" />
        <line x1="48" y1="41" x2="50" y2="48" stroke="rgba(0,0,0,0.12)" strokeWidth="1.5" />
        <line x1="74" y1="42" x2="70" y2="48" stroke="rgba(0,0,0,0.12)" strokeWidth="1.5" />
      </g>
    );
    return null; // curly = all back
  };

  // === HATS ===
  const hatEl = () => {
    if (hat === 'beanie') return (
      <g>
        <path d="M 8 56 Q 8 4 50 4 Q 92 4 92 56 Q 78 38 50 36 Q 22 38 8 56 Z" fill="#ef4444" />
        <rect x="8" y="47" width="84" height="13" rx="6" fill="#dc2626" />
        <line x1="28" y1="48" x2="26" y2="60" stroke="#b91c1c" strokeWidth="1.5" />
        <line x1="50" y1="48" x2="50" y2="60" stroke="#b91c1c" strokeWidth="1.5" />
        <line x1="72" y1="48" x2="74" y2="60" stroke="#b91c1c" strokeWidth="1.5" />
        <circle cx="50" cy="7" r="10" fill="white" />
        <circle cx="46" cy="4" r="3.5" fill="#f3f4f6" />
      </g>
    );
    if (hat === 'cap') return (
      <g>
        <path d="M 14 57 Q 14 12 50 12 Q 86 12 86 57 Q 74 39 50 37 Q 26 39 14 57 Z" fill="#1e40af" />
        <path d="M 2 57 Q 50 70 98 57 Q 95 49 50 49 Q 5 49 2 57 Z" fill="#1e3a8a" />
        <rect x="14" y="50" width="72" height="9" fill="#1d4ed8" />
        <circle cx="50" cy="13" r="3.5" fill="#93c5fd" />
      </g>
    );
    if (hat === 'crown') return (
      <g>
        <rect x="16" y="22" width="68" height="28" rx="3" fill="#F59E0B" />
        <polygon points="16,22 24,3 33,22" fill="#F59E0B" />
        <polygon points="41,22 50,1 59,22" fill="#F59E0B" />
        <polygon points="67,22 76,3 84,22" fill="#F59E0B" />
        <circle cx="50" cy="32" r="5" fill="#ef4444" />
        <circle cx="26" cy="33" r="4" fill="#3b82f6" />
        <circle cx="74" cy="33" r="4" fill="#10b981" />
        <rect x="16" y="46" width="68" height="6" rx="2" fill="#D97706" />
        <rect x="16" y="22" width="68" height="4" rx="1" fill="rgba(255,255,255,0.25)" />
      </g>
    );
    if (hat === 'mortarboard') return (
      <g>
        <path d="M 18 53 Q 18 9 50 9 Q 82 9 82 53 Q 70 37 50 35 Q 30 37 18 53 Z" fill="#1e293b" />
        <ellipse cx="50" cy="19" rx="43" ry="9" fill="#1e293b" />
        <ellipse cx="50" cy="17" rx="42" ry="7.5" fill="#0f172a" />
        <line x1="82" y1="17" x2="93" y2="44" stroke="#F59E0B" strokeWidth="2.5" />
        <circle cx="93" cy="46" r="4" fill="#F59E0B" />
        <line x1="91" y1="46" x2="88" y2="57" stroke="#D97706" strokeWidth="1.5" />
        <line x1="93" y1="46" x2="93" y2="58" stroke="#D97706" strokeWidth="1.5" />
        <line x1="95" y1="46" x2="97" y2="56" stroke="#D97706" strokeWidth="1.5" />
      </g>
    );
    return null;
  };

  // === GLASSES ===
  const glassesEl = () => {
    if (glasses === 'round') return (
      <g>
        <circle cx="33" cy="53" r="11" fill="none" stroke="#7C3AED" strokeWidth="3" />
        <circle cx="67" cy="53" r="11" fill="none" stroke="#7C3AED" strokeWidth="3" />
        <line x1="44" y1="53" x2="56" y2="53" stroke="#7C3AED" strokeWidth="2.5" />
        <line x1="4" y1="51" x2="22" y2="53" stroke="#7C3AED" strokeWidth="2" />
        <line x1="96" y1="51" x2="78" y2="53" stroke="#7C3AED" strokeWidth="2" />
      </g>
    );
    if (glasses === 'shades') return (
      <g>
        <rect x="13" y="44" width="30" height="18" rx="7" fill="#1e293b" />
        <rect x="57" y="44" width="30" height="18" rx="7" fill="#1e293b" />
        <line x1="43" y1="53" x2="57" y2="53" stroke="#1e293b" strokeWidth="3" />
        <line x1="4" y1="51" x2="13" y2="53" stroke="#334155" strokeWidth="2.5" />
        <line x1="96" y1="51" x2="87" y2="53" stroke="#334155" strokeWidth="2.5" />
        <line x1="17" y1="47" x2="21" y2="57" stroke="rgba(255,255,255,0.18)" strokeWidth="5" strokeLinecap="round" />
        <line x1="61" y1="47" x2="65" y2="57" stroke="rgba(255,255,255,0.18)" strokeWidth="5" strokeLinecap="round" />
      </g>
    );
    if (glasses === 'heart') return (
      <g>
        <path d="M 22 53 C 22 45 28 41 33 45 C 38 41 44 45 44 53 C 44 60 33 67 33 67 C 33 67 22 60 22 53 Z" fill="#ec4899" />
        <path d="M 56 53 C 56 45 62 41 67 45 C 72 41 78 45 78 53 C 78 60 67 67 67 67 C 67 67 56 60 56 53 Z" fill="#ec4899" />
        <line x1="44" y1="52" x2="56" y2="52" stroke="#db2777" strokeWidth="2.5" />
        <line x1="4" y1="51" x2="22" y2="53" stroke="#db2777" strokeWidth="2" />
        <line x1="96" y1="51" x2="78" y2="53" stroke="#db2777" strokeWidth="2" />
      </g>
    );
    if (glasses === 'star') return (
      <g>
        <polygon points="33,41 36,49 44,49 38,54 40,63 33,58 26,63 28,54 22,49 30,49" fill="#F59E0B" />
        <polygon points="67,41 70,49 78,49 72,54 74,63 67,58 60,63 62,54 56,49 64,49" fill="#F59E0B" />
        <line x1="44" y1="52" x2="56" y2="52" stroke="#D97706" strokeWidth="2" />
        <line x1="4" y1="51" x2="22" y2="52" stroke="#D97706" strokeWidth="2" />
        <line x1="96" y1="51" x2="78" y2="52" stroke="#D97706" strokeWidth="2" />
      </g>
    );
    return null;
  };

  // === EXTRAS (front-layer accessories) ===
  const extraFront = () => {
    if (extra === 'scarf') return (
      <g>
        <rect x="12" y="89" width="76" height="16" rx="8" fill="#ef4444" />
        <rect x="12" y="94" width="76" height="3" rx="1" fill="white" />
        <rect x="12" y="99" width="76" height="3" rx="1" fill="white" />
        <rect x="54" y="93" width="12" height="22" rx="6" fill="#ef4444" />
        <line x1="56" y1="99" x2="64" y2="99" stroke="white" strokeWidth="2" />
        <line x1="56" y1="104" x2="64" y2="104" stroke="white" strokeWidth="2" />
      </g>
    );
    if (extra === 'bow') return (
      <g>
        <path d="M 22 85 L 50 91 L 22 97 Z" fill="#7C3AED" />
        <path d="M 78 85 L 50 91 L 78 97 Z" fill="#7C3AED" />
        <circle cx="50" cy="91" r="6" fill="#5B21B6" />
        <circle cx="33" cy="88" r="2" fill="#A78BFA" />
        <circle cx="67" cy="88" r="2" fill="#A78BFA" />
      </g>
    );
    if (extra === 'headband') return (
      <g>
        <path d="M 11 47 Q 50 35 89 47 Q 87 40 50 28 Q 13 40 11 47 Z" fill="#f472b6" />
        <circle cx="76" cy="37" r="5" fill="#fbbf24" />
        <circle cx="76" cy="30" r="5" fill="#fda4af" />
        <circle cx="82" cy="34" r="5" fill="#fda4af" />
        <circle cx="82" cy="41" r="5" fill="#fda4af" />
        <circle cx="76" cy="44" r="5" fill="#fda4af" />
        <circle cx="70" cy="41" r="5" fill="#fda4af" />
        <circle cx="70" cy="34" r="5" fill="#fda4af" />
        <circle cx="76" cy="37" r="5" fill="#fbbf24" />
      </g>
    );
    if (extra === 'earrings') return (
      <g>
        <circle cx="9" cy="62" r="4" fill="#F59E0B" />
        <circle cx="91" cy="62" r="4" fill="#F59E0B" />
        <path d="M 6 66 Q 9 76 12 66" fill="none" stroke="#F59E0B" strokeWidth="2.5" />
        <path d="M 88 66 Q 91 76 94 66" fill="none" stroke="#F59E0B" strokeWidth="2.5" />
      </g>
    );
    return null;
  };

  // viewBox is 100Ã—108 â€” face at cy=54, gives room for tall hair above and scarf below
  return (
    <svg width={size} height={Math.round(size * 1.08)} viewBox="0 0 100 108"
      style={{ display: 'block', flexShrink: 0, overflow: 'visible' }}>

      {backHair()}

      {/* FACE BASE */}
      <circle cx="50" cy="54" r="44" fill={YELLOW} />
      <circle cx="50" cy="54" r="44" fill="rgba(0,0,0,0.04)" />

      {/* â”€â”€ JOYFUL â”€â”€ */}
      <g style={fade(2)}>
        <ellipse cx="33" cy="47" rx="5" ry="3.5" fill="white" />
        <ellipse cx="67" cy="47" rx="5" ry="3.5" fill="white" />
        <circle cx="33" cy="48" r="2" fill="#1e293b" /><circle cx="67" cy="48" r="2" fill="#1e293b" />
        <path d="M 25 38 Q 33 32 41 37" stroke={OUTLINE} strokeWidth="2.5" strokeLinecap="round" fill="none" />
        <path d="M 59 37 Q 67 32 75 38" stroke={OUTLINE} strokeWidth="2.5" strokeLinecap="round" fill="none" />
        <path d="M 26 66 Q 50 85 74 66" stroke={OUTLINE} strokeWidth="4" strokeLinecap="round" fill="none" />
        <circle cx="24" cy="59" r="8" fill="rgba(239,68,68,0.18)" />
        <circle cx="76" cy="59" r="8" fill="rgba(239,68,68,0.18)" />
        <line x1="87" y1="26" x2="87" y2="34" stroke="#F59E0B" strokeWidth="2.5" />
        <line x1="83" y1="30" x2="91" y2="30" stroke="#F59E0B" strokeWidth="2.5" />
        <circle cx="87" cy="30" r="2" fill="#FBBF24" />
      </g>

      {/* â”€â”€ CONTENT â”€â”€ */}
      <g style={fade(1)}>
        <ellipse cx="33" cy="47" rx="5" ry="5.5" fill="white" />
        <ellipse cx="67" cy="47" rx="5" ry="5.5" fill="white" />
        <circle cx="33" cy="48" r="2.5" fill="#1e293b" /><circle cx="67" cy="48" r="2.5" fill="#1e293b" />
        <path d="M 25 38 Q 33 33 41 37" stroke={OUTLINE} strokeWidth="2.5" strokeLinecap="round" fill="none" />
        <path d="M 59 37 Q 67 33 75 38" stroke={OUTLINE} strokeWidth="2.5" strokeLinecap="round" fill="none" />
        <path d="M 30 67 Q 50 79 70 67" stroke={OUTLINE} strokeWidth="3.5" strokeLinecap="round" fill="none" />
      </g>

      {/* â”€â”€ NEUTRAL â”€â”€ */}
      <g style={fade(0)}>
        <ellipse cx="33" cy="47" rx="5" ry="6" fill="white" />
        <ellipse cx="67" cy="47" rx="5" ry="6" fill="white" />
        <circle cx="33" cy="48" r="2.5" fill="#1e293b" /><circle cx="67" cy="48" r="2.5" fill="#1e293b" />
        <path d="M 25 38 L 41 38" stroke={OUTLINE} strokeWidth="2.5" strokeLinecap="round" />
        <path d="M 59 38 L 75 38" stroke={OUTLINE} strokeWidth="2.5" strokeLinecap="round" />
        <path d="M 33 68 L 67 68" stroke={OUTLINE} strokeWidth="3.5" strokeLinecap="round" />
      </g>

      {/* â”€â”€ STRESSED â”€â”€ */}
      <g style={fade(-1)}>
        <ellipse cx="33" cy="47" rx="5" ry="5.5" fill="white" />
        <ellipse cx="67" cy="47" rx="5" ry="5.5" fill="white" />
        <circle cx="33" cy="48" r="2.5" fill="#1e293b" /><circle cx="67" cy="48" r="2.5" fill="#1e293b" />
        <path d="M 24 36 Q 33 42 42 37" stroke={OUTLINE} strokeWidth="2.5" strokeLinecap="round" fill="none" />
        <path d="M 58 37 Q 67 42 76 36" stroke={OUTLINE} strokeWidth="2.5" strokeLinecap="round" fill="none" />
        <path d="M 31 71 Q 50 63 69 71" stroke={OUTLINE} strokeWidth="3.5" strokeLinecap="round" fill="none" />
      </g>

      {/* â”€â”€ OVERWHELMED â”€â”€ */}
      <g style={fade(-2)}>
        <ellipse cx="33" cy="46" rx="6" ry="6.5" fill="white" />
        <ellipse cx="67" cy="46" rx="6" ry="6.5" fill="white" />
        <circle cx="33" cy="47" r="3" fill="#1e293b" /><circle cx="67" cy="47" r="3" fill="#1e293b" />
        <path d="M 22 32 Q 33 42 45 35" stroke={OUTLINE} strokeWidth="2.5" strokeLinecap="round" fill="none" />
        <path d="M 55 35 Q 67 42 78 32" stroke={OUTLINE} strokeWidth="2.5" strokeLinecap="round" fill="none" />
        <path d="M 27 73 Q 50 60 73 73" stroke={OUTLINE} strokeWidth="4" strokeLinecap="round" fill="none" />
        {/* Sweat drop */}
        <circle cx="81" cy="30" r="3.5" fill="#BAE6FD" />
        <path d="M 81 26 Q 85 28 81 37 Q 77 28 81 26 Z" fill="#BAE6FD" />
        {/* Worry lines */}
        <line x1="13" y1="34" x2="20" y2="43" stroke="#D97706" strokeWidth="2" strokeLinecap="round" />
        <line x1="87" y1="34" x2="80" y2="43" stroke="#D97706" strokeWidth="2" strokeLinecap="round" />
      </g>

      {frontHair()}
      {hatEl()}
      {glassesEl()}
      {extraFront()}
    </svg>
  );
}

// ========== CHARACTER STRENGTHS DATA ==========

const characterStrengths = [
  {
    id: 'creative',
    name: 'Creative Thinker',
    emoji: 'ğŸ¨',
    description: 'You find unique solutions to problems',
    hint: 'Think outside the box - there might be a creative approach here!'
  },
  {
    id: 'friend',
    name: 'Good Friend',
    emoji: 'ğŸ¤',
    description: 'You understand and support others',
    hint: 'How would a caring friend handle this situation?'
  },
  {
    id: 'calm',
    name: 'Calm Under Pressure',
    emoji: 'ğŸ§˜',
    description: 'You stay cool when things get tough',
    hint: 'Take a breath - staying calm will help you choose wisely.'
  },
  {
    id: 'brave',
    name: 'Brave Heart',
    emoji: 'ğŸ¦',
    description: 'You have courage to do what\'s right',
    hint: 'Sometimes the brave choice is the hardest one.'
  },
  {
    id: 'thoughtful',
    name: 'Deep Thinker',
    emoji: 'ğŸ¤”',
    description: 'You consider consequences carefully',
    hint: 'Think ahead - what might happen after each choice?'
  },
  {
    id: 'positive',
    name: 'Optimistic Spirit',
    emoji: 'âœ¨',
    description: 'You find the bright side',
    hint: 'Look for the positive possibility in your choices!'
  }
];

// ========== DAY FLAGS SYSTEM ==========

const getCarryForwardMessages = (scenario, flags) => {
  const msgs = [];
  if (!flags || !flags.length || scenario.timeOrder <= 1) return msgs;

  if (flags.includes('rough_start') && scenario.timeOrder >= 2) {
    msgs.push({ text: "You're still carrying some stress from this morning...", icon: 'ğŸ˜Ÿ', type: 'warning' });
  }
  if (flags.includes('good_start') && scenario.timeOrder >= 2) {
    msgs.push({ text: "Your great morning start is giving you extra confidence!", icon: 'â­', type: 'boost' });
  }
  if (flags.includes('bus_trouble') && scenario.timeOrder >= 3) {
    msgs.push({ text: "That rough ride is still bugging you a little...", icon: 'ğŸ˜¤', type: 'warning' });
  }
  if (flags.includes('bus_win') && !flags.includes('bus_trouble') && scenario.timeOrder >= 3) {
    msgs.push({ text: "You felt great after that smooth start to the day!", icon: 'ğŸ˜Š', type: 'boost' });
  }
  if (flags.includes('social_win') && scenario.timeOrder >= 5) {
    msgs.push({ text: "That positive connection earlier is still boosting your mood!", icon: 'âœ¨', type: 'boost' });
  }
  if (flags.includes('class_struggle') && scenario.timeOrder >= 7) {
    msgs.push({ text: "Classes have been rough today â€” you're feeling the pressure...", icon: 'ğŸ˜“', type: 'warning' });
  }
  const badFlags = flags.filter(f => ['rough_start', 'bus_trouble', 'class_struggle', 'social_struggle'].includes(f));
  if (badFlags.length >= 2 && scenario.timeOrder >= 5) {
    msgs.push({ text: "It's been a tough day. Keep going â€” you've got this!", icon: 'ğŸ’™', type: 'encourage' });
  }

  // HS-specific narrative carries
  if (flags.includes('game_day_bail') && scenario.timeOrder >= 5) {
    msgs.push({ text: "Missing the playoff this morning is still weighing on you.", icon: 'ğŸ˜“', type: 'warning' });
  }
  if (flags.includes('game_day_courage') && scenario.timeOrder >= 5) {
    msgs.push({ text: "You showed up when it mattered this morning. That energy is still with you.", icon: 'ğŸ†', type: 'boost' });
  }
  if (flags.includes('destiny_got_help') && scenario.timeOrder >= 10) {
    msgs.push({ text: "Destiny got real help because of you. That was the most important choice today.", icon: 'ğŸ’›', type: 'boost' });
  }
  if (flags.includes('destiny_secret_kept') && scenario.timeOrder >= 10) {
    msgs.push({ text: "You're carrying something heavy â€” Destiny needs more support than you alone can give.", icon: 'ğŸ˜Ÿ', type: 'warning' });
  }
  if (flags.includes('coach_ultimatum_resolved') && scenario.timeOrder >= 8) {
    msgs.push({ text: "Your grade is moving in the right direction. Coach Reyes sees the effort.", icon: 'ğŸ“ˆ', type: 'boost' });
  }
  if (flags.includes('test_cheated') && scenario.timeOrder >= 11) {
    msgs.push({ text: "Something from that test is sitting with you quietly...", icon: 'âš ï¸', type: 'warning' });
  }
  if (flags.includes('test_integrity') && scenario.timeOrder >= 11) {
    msgs.push({ text: "You earned that grade honestly. That counts for something real.", icon: 'âœ…', type: 'boost' });
  }
  if (flags.includes('okafor_connected') && scenario.timeOrder >= 13) {
    msgs.push({ text: "You have a meeting with Dr. Okafor. You chose not to be alone in this.", icon: 'ğŸ’¬', type: 'boost' });
  }
  if (flags.includes('marcus_ally') && scenario.id === 'h12') {
    msgs.push({ text: "Marcus has been decent to you lately. This invite might be genuine.", icon: 'ğŸ¤”', type: 'encourage' });
  }
  if (flags.includes('jordan_supported') && scenario.timeOrder >= 12) {
    msgs.push({ text: "Jordan is getting help because you noticed. That's the kind of person you are.", icon: 'ğŸ’š', type: 'boost' });
  }

  return msgs;
};

const buildNewFlags = (choice, scenario, currentFlags) => {
  const newFlags = [...currentFlags];
  const isGood = choice.points >= 1;
  const isBad = choice.points <= -1;

  if (scenario.timeOrder <= 1) {
    if (isGood && !newFlags.includes('good_start')) newFlags.push('good_start');
    if (isBad && !newFlags.includes('rough_start')) newFlags.push('rough_start');
  }

  if (scenario.timeOfDay?.toLowerCase().includes('bus') || scenario.timeOrder === 2) {
    if (isGood && !newFlags.includes('bus_win')) newFlags.push('bus_win');
    if (isBad && !newFlags.includes('bus_trouble')) newFlags.push('bus_trouble');
  }

  if (scenario.timeOrder >= 3 && scenario.timeOrder <= 6) {
    if (isGood && !newFlags.includes('class_win')) newFlags.push('class_win');
    if (isBad && !newFlags.includes('class_struggle')) newFlags.push('class_struggle');
  }

  const socialKeywords = ['Collaboration', 'Social Problem', 'Active Inclusion', 'Cooperation', 'Peacemaking', 'Active Protection', 'Inclusive'];
  if (socialKeywords.some(kw => choice.skill?.includes(kw.split(' ')[0]))) {
    if (isGood && !newFlags.includes('social_win')) newFlags.push('social_win');
    if (isBad && !newFlags.includes('social_struggle')) newFlags.push('social_struggle');
  }

  // HS-specific narrative flags
  if (scenario.id === 'h1') {
    if (isGood && !newFlags.includes('game_day_courage')) newFlags.push('game_day_courage');
    if (choice.points === -2 && !newFlags.includes('game_day_bail')) newFlags.push('game_day_bail');
  }
  if (scenario.id === 'h6') {
    if (choice.points >= 1 && !newFlags.includes('destiny_got_help')) newFlags.push('destiny_got_help');
    if (choice.points <= -1 && !newFlags.includes('destiny_secret_kept')) newFlags.push('destiny_secret_kept');
  }
  if (scenario.id === 'h3') {
    if (isGood && !newFlags.includes('coach_ultimatum_resolved')) newFlags.push('coach_ultimatum_resolved');
    if (isBad && !newFlags.includes('coach_ultimatum_failed')) newFlags.push('coach_ultimatum_failed');
  }
  if (scenario.id === 'h4') {
    if (isGood && !newFlags.includes('marcus_ally')) newFlags.push('marcus_ally');
    if (isBad && !newFlags.includes('marcus_tension')) newFlags.push('marcus_tension');
  }
  if (scenario.id === 'h9') {
    if (isGood && !newFlags.includes('okafor_connected')) newFlags.push('okafor_connected');
    if (isBad && !newFlags.includes('okafor_avoided')) newFlags.push('okafor_avoided');
  }
  if (scenario.id === 'h10') {
    if (isGood && !newFlags.includes('test_integrity')) newFlags.push('test_integrity');
    if (isBad && !newFlags.includes('test_cheated')) newFlags.push('test_cheated');
  }
  if (scenario.id === 'h11') {
    if (isGood && !newFlags.includes('jordan_supported')) newFlags.push('jordan_supported');
  }

  return newFlags;
};

// ========== MAIN COMPONENT ==========

export default function SELAdventure() {
  const [gameState, setGameState] = useState('start');
  const [gradeLevel, setGradeLevel] = useState(null);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [scenarios, setScenarios] = useState([]);
  const [shuffledChoices, setShuffledChoices] = useState([]);
  const [selectedChoice, setSelectedChoice] = useState(null);
  const [modifiedConsequence, setModifiedConsequence] = useState(null);
  const [score, setScore] = useState(0);
  const [responses, setResponses] = useState([]);
  const [playerName, setPlayerName] = useState('');
  const [accessories, setAccessories] = useState({ hair: 'none', hat: 'none', glasses: 'none', extra: 'none' });
  const [accCategory, setAccCategory] = useState('hair');
  const [showReflection, setShowReflection] = useState(false);
  const [scenarioCount, setScenarioCount] = useState(7);
  const [stress, setStress] = useState(2);
  const [calm, setCalm] = useState(5);
  const [stressHistory, setStressHistory] = useState([2]);
  const [dayFlags, setDayFlags] = useState([]);
  const [lastMeterChange, setLastMeterChange] = useState(null);

  // Character development states
  const [characterStrength, setCharacterStrength] = useState(null);
  const [backstoryAnswers, setBackstoryAnswers] = useState({
    calmActivity: '',
    supportPerson: '',
    proudMoment: ''
  });
  const [showHint, setShowHint] = useState(false);
  const [reflectionText, setReflectionText] = useState('');
  const [hasSavedGame, setHasSavedGame] = useState(false);
  const [streak, setStreak] = useState(0);
  const [badges, setBadges] = useState([]);
  const [newBadge, setNewBadge] = useState(null);
  const [discussionMode, setDiscussionMode] = useState(true);

  const gradeLevels = [
    { id: 'elementary', name: 'Elementary School', grades: 'K-5', emoji: 'ğŸ¨', color: '#10b981', data: elementaryScenarios },
    { id: 'middle', name: 'Middle School', grades: '6-8', emoji: 'ğŸ“š', color: '#6366f1', data: middleSchoolScenarios },
    { id: 'high', name: 'High School', grades: '9-12', emoji: 'ğŸ“', color: '#8b5cf6', data: highSchoolScenarios }
  ];

  useEffect(() => {
    if (gameState === 'playing' && scenarios[currentIndex]) {
      setShuffledChoices(shuffleArray(scenarios[currentIndex].choices));
    }
  }, [currentIndex, gameState, scenarios]);

  // Check for saved game on mount
  useEffect(() => {
    try {
      const saved = localStorage.getItem('sel_saved_game');
      if (saved) {
        const parsed = JSON.parse(saved);
        if (parsed && ['playing', 'consequence'].includes(parsed.gameState)) {
          setHasSavedGame(true);
        }
      }
    } catch (e) {}
  }, []);

  // Auto-save game progress & record to teacher log on complete
  useEffect(() => {
    if (['playing', 'consequence'].includes(gameState)) {
      try {
        localStorage.setItem('sel_saved_game', JSON.stringify({
          gameState, gradeLevel, playerName, accessories, scenarioCount,
          currentIndex, scenarios, score, responses, stress, calm,
          stressHistory, dayFlags, characterStrength, backstoryAnswers,
          selectedChoice, modifiedConsequence, streak, badges
        }));
      } catch (e) {}
    } else if (gameState === 'complete') {
      localStorage.removeItem('sel_saved_game');
      try {
        const existing = JSON.parse(localStorage.getItem('sel_teacher_data') || '[]');
        existing.push({
          ts: Date.now(), gradeLevel,
          playerName: playerName || 'Anonymous',
          score, maxScore: scenarioCount * 3, scenarioCount,
          responses: responses.map(r => ({
            scenario: r.scenario, skill: r.skill,
            points: r.points, reflection: r.reflection || ''
          }))
        });
        localStorage.setItem('sel_teacher_data', JSON.stringify(existing.slice(-100)));
      } catch (e) {}
    }
  }, [gameState, currentIndex, score, responses]);

  const resumeGame = () => {
    try {
      const saved = JSON.parse(localStorage.getItem('sel_saved_game'));
      if (!saved) return;
      setGameState(saved.gameState);
      setGradeLevel(saved.gradeLevel);
      setPlayerName(saved.playerName || '');
      setAccessories(saved.accessories || { hair: 'none', hat: 'none', glasses: 'none', extra: 'none' });
      setScenarioCount(saved.scenarioCount || 7);
      setCurrentIndex(saved.currentIndex || 0);
      setScenarios(saved.scenarios || []);
      setScore(saved.score || 0);
      setResponses(saved.responses || []);
      setStress(saved.stress ?? 2);
      setCalm(saved.calm ?? 5);
      setStressHistory(saved.stressHistory || [2]);
      setDayFlags(saved.dayFlags || []);
      setCharacterStrength(saved.characterStrength || null);
      setBackstoryAnswers(saved.backstoryAnswers || { calmActivity: '', supportPerson: '', proudMoment: '' });
      setSelectedChoice(saved.selectedChoice || null);
      setModifiedConsequence(saved.modifiedConsequence || null);
      setStreak(saved.streak || 0);
      setBadges(saved.badges || []);
      setHasSavedGame(false);
    } catch (e) {}
  };

  const startGame = () => {
    const level = gradeLevels.find(l => l.id === gradeLevel);
    const selected = selectScenariosForDay(level.data, scenarioCount);
    setScenarios(selected);
    setCurrentIndex(0);
    setScore(0);
    setResponses([]);
    setStress(2);
    setCalm(5);
    setStressHistory([2]);
    setDayFlags([]);
    setLastMeterChange(null);
    setGameState('playing');
  };

  const handleChoice = (choice) => {
    const stressBefore = stress;
    const mod = getModifiedConsequence(choice, stress);
    const newStress = Math.max(0, Math.min(12, stress + mod.stressChange));
    const newCalm = Math.max(0, Math.min(10, calm + mod.calmChange));

    setStress(newStress);
    setCalm(newCalm);
    setStressHistory(prev => [...prev, newStress]);
    setLastMeterChange({ stress: mod.stressChange, calm: mod.calmChange });

    const newFlags = buildNewFlags(choice, scenarios[currentIndex], dayFlags);
    setDayFlags(newFlags);

    const total = choice.points + mod.bonusPoints;
    setSelectedChoice(choice);
    setModifiedConsequence(mod);
    setScore(prev => prev + total);

    // Track streak (resets on any negative choice)
    const newStreak = choice.points > 0 ? streak + 1 : 0;
    setStreak(newStreak);

    // Build updated responses array now (can't rely on state yet)
    const newResponse = {
      scenario: scenarios[currentIndex].title,
      timeOfDay: scenarios[currentIndex].timeOfDay,
      skill: choice.skill,
      points: total,
      stressBefore,
      stressAfter: newStress,
      calmAfter: newCalm
    };
    const newResponses = [...responses, newResponse];
    setResponses(newResponses);

    // Check which badges are now earned
    const prevBadgeIds = new Set(badges.map(b => b.id));
    const nowEarned = BADGES.filter(b => b.check(newResponses, newStreak));
    setBadges(nowEarned);
    const newlyEarned = nowEarned.filter(b => !prevBadgeIds.has(b.id));
    if (newlyEarned.length > 0) setNewBadge(newlyEarned[0]);

    // Go to discussion pause (if enabled) or straight to consequence
    setGameState(discussionMode ? 'discussion' : 'consequence');
  };

  const nextScenario = () => {
    if (reflectionText.trim()) {
      setResponses(prev => {
        const updated = [...prev];
        if (updated.length > 0) {
          updated[updated.length - 1] = { ...updated[updated.length - 1], reflection: reflectionText.trim() };
        }
        return updated;
      });
    }
    setReflectionText('');
    setShowReflection(false);
    if (currentIndex < scenarios.length - 1) {
      setCurrentIndex(prev => prev + 1);
      setSelectedChoice(null);
      setModifiedConsequence(null);
      setLastMeterChange(null);
      setGameState('playing');
    } else {
      setGameState('complete');
    }
  };

  const getStressColor = (l) => l <= 3 ? '#10b981' : l <= 6 ? '#f59e0b' : l <= 9 ? '#f97316' : '#ef4444';
  const getStressLabel = (l) => l <= 3 ? 'Calm' : l <= 6 ? 'Moderate' : l <= 9 ? 'High' : 'Overwhelmed';
  const getStressFace = (l) => l <= 2 ? 'ğŸ˜Œ' : l <= 4 ? 'ğŸ˜' : l <= 6 ? 'ğŸ˜Ÿ' : l <= 9 ? 'ğŸ˜¤' : 'ğŸ˜¡';
  const getCalmColor = (l) => l >= 7 ? '#10b981' : l >= 4 ? '#f59e0b' : '#ef4444';
  const getCalmLabel = (l) => l >= 8 ? 'Happy!' : l >= 6 ? 'Good' : l >= 4 ? 'Okay' : l >= 2 ? 'Low' : 'Struggling';
  const getCalmFace = (l) => l >= 8 ? 'ğŸ˜„' : l >= 6 ? 'ğŸ˜Š' : l >= 4 ? 'ğŸ™‚' : l >= 2 ? 'ğŸ˜•' : 'ğŸ˜¢';

  const getDayTimeline = () => {
    if (!scenarios.length) return [];
    const uniqueOrders = [...new Set(scenarios.map(s => s.timeOrder))].sort((a, b) => a - b);
    return uniqueOrders.map(order => {
      const s = scenarios.find(sc => sc.timeOrder === order);
      const emojiMatch = s?.timeOfDay?.match(/\p{Emoji_Presentation}/gu);
      const emoji = emojiMatch?.[0] || 'â°';
      const isDone = responses.some(r => {
        const rs = scenarios.find(sc => sc.title === r.scenario);
        return rs?.timeOrder === order;
      });
      const isCurrent = scenarios[currentIndex]?.timeOrder === order;
      return { order, emoji, done: isDone, current: isCurrent };
    });
  };

  const getCharacterExpression = () => {
    if (stress >= 9) return { mouth: 'ğŸ˜°', eyes: 'ğŸ˜–', face: 'overwhelmed' };
    if (stress >= 6) return { mouth: 'ğŸ˜Ÿ', eyes: 'ğŸ˜•', face: 'stressed' };
    if (calm >= 7 && stress < 6) return { mouth: 'ğŸ˜Š', eyes: 'ğŸ˜„', face: 'happy' };
    if (calm < 4) return { mouth: 'ğŸ˜”', eyes: 'ğŸ˜¢', face: 'sad' };
    return { mouth: 'ğŸ™‚', eyes: 'ğŸ˜', face: 'neutral' };
  };

  const getInnerThought = () => {
    if (stress >= 9 && calm < 4) {
      return "Everything feels like too much right now...";
    } else if (stress >= 9) {
      return "I'm feeling really overwhelmed...";
    } else if (stress >= 6 && calm >= 7) {
      return "I'm stressed but I can handle this.";
    } else if (stress >= 6) {
      return "Things are getting harder to manage...";
    } else if (calm >= 7) {
      return "I'm feeling good about how things are going!";
    } else if (calm < 4) {
      return "I wish I could do better...";
    } else {
      return "Taking it one step at a time.";
    }
  };

  const getScoreLevel = () => {
    const max = scenarioCount * 3;
    const pct = (score / max) * 100;
    if (pct >= 80) return { level: "Coping Champion", color: "#10b981", msg: "You consistently chose strategies that lead to positive outcomes!" };
    if (pct >= 60) return { level: "Skilled Navigator", color: "#6366f1", msg: "You made mostly helpful choices with room to grow." };
    if (pct >= 40) return { level: "Learning Explorer", color: "#f59e0b", msg: "You're learning which strategies work best." };
    return { level: "Beginning Adventurer", color: "#f43f5e", msg: "Keep practicing! Every challenge is a chance to learn." };
  };

  const isCrisisChoice = (choice) => choice && choice.points === -2 &&
    ['Catastrophic Thinking', 'Alarming Deflection', 'Catastrophic Hopelessness',
     'Fear-Based Paralysis', 'Coerced Compliance'].includes(choice.skill);

  const downloadJournal = () => {
    const lines = [
      'SEL Adventure â€” My Reflection Journal',
      `Player: ${playerName || 'Anonymous'}`,
      `Date: ${new Date().toLocaleDateString()}`,
      `Score: ${score} / ${scenarioCount * 3}`,
      '',
      '=== My Day ===',
      ...responses.map((r, i) => [
        `\n${i + 1}. ${r.timeOfDay} â€” ${r.scenario}`,
        `   Skill: ${r.skill} (${r.points > 0 ? '+' : ''}${r.points} pts)`,
        r.reflection ? `   My reflection: "${r.reflection}"` : ''
      ].filter(Boolean).join('\n'))
    ];
    const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sel-journal-${(playerName || 'anonymous').replace(/\s+/g, '-')}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const getTeacherData = () => {
    try { return JSON.parse(localStorage.getItem('sel_teacher_data') || '[]'); }
    catch (e) { return []; }
  };

  const currentScenario = scenarios[currentIndex] ? getStressModifiedScenario(scenarios[currentIndex], stress, calm, dayFlags) : null;
  const carryForwardMsgs = currentScenario ? getCarryForwardMessages(currentScenario, dayFlags) : [];
  const levelColor = gradeLevels.find(l => l.id === gradeLevel)?.color || '#6366f1';

  // STYLES
  const styles = `
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Fredoka+One&display=swap');
    * { box-sizing: border-box; }
    .card { background: white; border-radius: 24px; padding: 32px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); max-width: 600px; width: 100%; margin: 0 auto; }
    .title { font-family: 'Fredoka One', cursive; font-size: 2.2rem; background: linear-gradient(135deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; margin-bottom: 8px; }
    .subtitle { color: #64748b; text-align: center; margin-bottom: 24px; }
    .label { font-weight: 700; color: #334155; margin-bottom: 10px; display: block; }
    .grade-btn { display: flex; align-items: center; gap: 14px; padding: 16px 20px; border: 3px solid #e2e8f0; border-radius: 14px; background: white; cursor: pointer; transition: all 0.2s; width: 100%; margin-bottom: 10px; font-family: inherit; }
    .grade-btn:hover { border-color: #a5b4fc; transform: translateX(4px); }
    .grade-btn.selected { border-color: var(--color); background: color-mix(in srgb, var(--color) 10%, white); }
    .grade-emoji { font-size: 1.8rem; }
    .grade-name { font-weight: 800; color: #1e293b; }
    .grade-range { color: #64748b; font-size: 0.85rem; }
    .input { width: 100%; padding: 14px 16px; border: 3px solid #e2e8f0; border-radius: 12px; font-size: 1rem; font-family: inherit; margin-bottom: 16px; }
    .input:focus { outline: none; border-color: #6366f1; }
    .acc-preview { display: flex; justify-content: center; margin-bottom: 14px; }
    .acc-tabs { display: flex; gap: 6px; justify-content: center; margin-bottom: 10px; }
    .acc-tab { padding: 8px 16px; border: 2px solid #e2e8f0; background: white; border-radius: 20px; font-weight: 700; font-size: 0.85rem; cursor: pointer; font-family: inherit; color: #64748b; transition: all 0.2s; }
    .acc-tab:hover { border-color: #6366f1; color: #6366f1; }
    .acc-tab.active { background: #6366f1; color: white; border-color: #6366f1; }
    .acc-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
    .acc-opt { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 10px 6px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; font-size: 0.8rem; font-weight: 700; color: #475569; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .acc-opt:hover { border-color: #6366f1; color: #6366f1; transform: translateY(-2px); }
    .acc-opt.selected { background: #ede9fe; border-color: #6366f1; color: #4f46e5; }
    .count-btns { display: flex; gap: 8px; justify-content: center; margin-bottom: 16px; }
    .count-btn { padding: 10px 20px; border: 3px solid #e2e8f0; background: white; border-radius: 10px; font-weight: 700; cursor: pointer; font-family: inherit; }
    .count-btn:hover { border-color: #6366f1; }
    .count-btn.selected { background: #6366f1; color: white; border-color: #6366f1; }
    .start-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 12px; font-size: 1.15rem; font-weight: 800; cursor: pointer; font-family: inherit; }
    .start-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(99,102,241,0.4); }
    .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; background: rgba(255,255,255,0.1); border-radius: 16px; margin-bottom: 14px; backdrop-filter: blur(10px); }
    .avatar { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: white; font-size: 1.2rem; }
    .player-name { color: white; font-weight: 700; margin-left: 10px; }
    .progress { color: rgba(255,255,255,0.8); font-size: 0.85rem; }
    .score { color: white; font-weight: 800; font-size: 1.1rem; }
    .meters { display: flex; gap: 14px; padding: 14px 18px; background: white; border-radius: 14px; margin-bottom: 14px; }
    .meter { flex: 1; }
    .meter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .meter-label { font-weight: 700; font-size: 0.8rem; color: #334155; }
    .meter-value { font-weight: 800; font-size: 0.75rem; padding: 2px 8px; border-radius: 20px; color: white; }
    .meter-track { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
    .meter-fill { height: 100%; border-radius: 4px; transition: all 0.4s; }
    .scenario-card { background: white; border-radius: 20px; padding: 28px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); }
    .warning { padding: 12px 16px; border-radius: 12px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 0.9rem; }
    .warning.stress { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; color: #92400e; }
    .warning.high-stress { background: linear-gradient(135deg, #fee2e2, #fecaca); border: 2px solid #ef4444; color: #991b1b; }
    .warning.wellbeing { background: linear-gradient(135deg, #d1fae5, #a7f3d0); border: 2px solid #10b981; color: #065f46; }
    .scenario-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .scenario-num { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: white; font-size: 1.2rem; }
    .scenario-title { font-family: 'Fredoka One', cursive; font-size: 1.4rem; color: #1e293b; margin: 0; }
    .scenario-time { font-size: 0.85rem; color: #6366f1; font-weight: 600; }
    .situation { font-size: 1.05rem; line-height: 1.6; color: #334155; padding: 18px; background: #f8fafc; border-radius: 14px; border-left: 4px solid #6366f1; margin-bottom: 20px; }
    .choices-label { font-weight: 700; color: #64748b; margin-bottom: 12px; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; }
    .choice-btn { width: 100%; padding: 16px 18px; text-align: left; background: #f8fafc; border: 3px solid #e2e8f0; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; cursor: pointer; transition: all 0.2s; font-family: inherit; color: #334155; margin-bottom: 8px; }
    .choice-btn:hover { border-color: #6366f1; background: white; transform: translateX(6px); }
    .consequence-card { background: white; border-radius: 24px; padding: 36px; max-width: 550px; width: 100%; text-align: center; }
    .result-emoji { font-size: 4rem; margin-bottom: 10px; }
    .points { font-family: 'Fredoka One', cursive; font-size: 2.5rem; margin-bottom: 4px; }
    .bonus { color: #059669; font-weight: 700; margin-bottom: 8px; }
    .skill-tag { display: inline-block; padding: 6px 16px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; margin-bottom: 16px; }
    .consequence-text { font-size: 1rem; line-height: 1.6; color: #334155; padding: 18px; background: #f8fafc; border-radius: 14px; margin-bottom: 16px; text-align: left; }
    .meter-changes { display: flex; gap: 14px; margin-bottom: 16px; }
    .meter-change { flex: 1; padding: 12px; border-radius: 12px; text-align: center; }
    .meter-change-label { font-size: 0.8rem; font-weight: 700; margin-bottom: 2px; }
    .meter-change-value { font-size: 1.2rem; font-weight: 800; }
    .next-btn { padding: 14px 40px; border: none; border-radius: 12px; font-size: 1.05rem; font-weight: 700; cursor: pointer; color: white; font-family: inherit; }
    .next-btn:hover { transform: translateY(-2px); }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; padding: 20px; z-index: 100; }
    .modal-content { background: white; border-radius: 20px; padding: 32px; max-width: 450px; width: 100%; text-align: center; }
    .modal-title { font-family: 'Fredoka One', cursive; font-size: 1.3rem; color: #6366f1; margin-bottom: 12px; }
    .modal-text { color: #334155; margin-bottom: 16px; line-height: 1.5; }
    .modal-hint { font-size: 0.9rem; color: #64748b; font-style: italic; margin-bottom: 16px; padding: 12px; background: #fef3c7; border-radius: 10px; }
    .modal-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-family: inherit; }
    .results-card { background: white; border-radius: 24px; padding: 36px; max-width: 650px; width: 100%; margin: 0 auto; }
    .trophy { font-size: 4rem; text-align: center; margin-bottom: 10px; }
    .results-title { font-family: 'Fredoka One', cursive; font-size: 1.8rem; color: #1e293b; text-align: center; margin-bottom: 8px; }
    .level-badge { display: block; margin: 0 auto 10px; padding: 8px 20px; border-radius: 20px; font-weight: 800; color: white; text-align: center; width: fit-content; }
    .level-msg { color: #64748b; text-align: center; margin-bottom: 20px; }
    .final-score-box { background: #f8fafc; border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 20px; }
    .final-score { font-family: 'Fredoka One', cursive; font-size: 3rem; color: #6366f1; }
    .score-max { color: #64748b; font-size: 0.9rem; }
    .progress-bar { height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; margin-top: 12px; }
    .progress-fill { height: 100%; border-radius: 6px; background: linear-gradient(90deg, #f43f5e, #f59e0b, #10b981); }
    .journey-box { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 16px; padding: 20px; margin-bottom: 20px; }
    .journey-title { font-weight: 800; color: #92400e; margin-bottom: 12px; }
    .journey-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .journey-stat { background: white; border-radius: 10px; padding: 12px; text-align: center; }
    .journey-stat-value { font-size: 1.3rem; font-weight: 800; color: #92400e; }
    .journey-stat-label { font-size: 0.75rem; color: #78716c; }
    .journey-insight { margin-top: 12px; padding: 12px; background: white; border-radius: 10px; font-size: 0.9rem; color: #78716c; }
    .response-list { max-height: 250px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; margin-bottom: 16px; }
    .response-item { padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid; }
    .response-item:last-child { margin-bottom: 0; }
    .response-scenario { font-weight: 700; color: #334155; font-size: 0.9rem; }
    .response-skill { font-size: 0.8rem; color: #64748b; }
    .response-points { float: right; font-weight: 800; }
    .response-stress { font-size: 0.75rem; color: #94a3b8; margin-top: 2px; }
    .restart-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 800; cursor: pointer; font-family: inherit; }
    .restart-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(99,102,241,0.4); }
    .character-visual { width: 120px; height: 120px; margin: 0 auto 16px; position: relative; }
    .character-face { width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; box-shadow: 0 8px 20px rgba(0,0,0,0.15); transition: all 0.3s ease; }
    .thought-bubble { position: relative; background: white; border-radius: 20px; padding: 16px 20px; margin: 16px auto; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 2px solid #e2e8f0; }
    .thought-bubble:before { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid white; }
    .thought-text { color: #334155; font-size: 0.95rem; font-style: italic; text-align: center; font-weight: 600; }
    .thought-emoji { font-size: 1.3rem; margin-right: 8px; }
    .backstory-input { width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; font-family: inherit; margin-bottom: 16px; resize: vertical; min-height: 60px; }
    .backstory-input:focus { outline: none; border-color: #6366f1; }
    /* ===== CHIP UI ===== */
    .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .chip { padding: 8px 14px; border: 2px solid #e2e8f0; border-radius: 20px; background: white; cursor: pointer; font-size: 0.82rem; font-family: inherit; display: flex; align-items: center; gap: 6px; transition: all 0.15s; color: #334155; font-weight: 600; }
    .chip:hover { border-color: #6366f1; background: #eef2ff; transform: translateY(-1px); }
    .chip.selected { border-color: #6366f1; background: #eef2ff; color: #4338ca; box-shadow: 0 0 0 2px rgba(99,102,241,0.2); }
    .strength-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
    .strength-btn { padding: 14px; border: 3px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; transition: all 0.2s; font-family: inherit; text-align: left; }
    .strength-btn:hover { border-color: #6366f1; transform: translateY(-2px); }
    .strength-btn.selected { border-color: #6366f1; background: #eef2ff; }
    .strength-emoji { font-size: 1.8rem; display: block; margin-bottom: 6px; }
    .strength-name { font-weight: 800; color: #1e293b; font-size: 0.9rem; display: block; margin-bottom: 3px; }
    .strength-desc { font-size: 0.75rem; color: #64748b; }
    .hint-box { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 14px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .hint-text { color: #92400e; font-weight: 600; font-size: 0.9rem; }
    .backstory-question { font-weight: 700; color: #334155; margin-bottom: 8px; font-size: 0.95rem; }
    /* ===== GAME-STYLE METERS ===== */
    .game-meters { display: flex; gap: 12px; padding: 16px; background: rgba(0,0,0,0.25); border-radius: 20px; margin-bottom: 14px; backdrop-filter: blur(10px); }
    .game-meter { flex: 1; background: rgba(255,255,255,0.1); border-radius: 16px; padding: 14px; }
    .calm-meter { border: 2px solid rgba(52,211,153,0.5); }
    .stress-meter { border: 2px solid rgba(239,68,68,0.5); }
    .meter-top { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .meter-face-icon { font-size: 2rem; line-height: 1; flex-shrink: 0; }
    .meter-meta { flex: 1; min-width: 0; }
    .meter-name { font-weight: 900; font-size: 0.65rem; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,0.7); margin-bottom: 2px; }
    .meter-status-label { font-size: 0.85rem; font-weight: 800; color: white; }
    .meter-bar-outer { height: 20px; background: rgba(0,0,0,0.35); border-radius: 10px; overflow: hidden; }
    .meter-bar-inner { height: 100%; border-radius: 10px; transition: width 0.5s cubic-bezier(0.34,1.56,0.64,1); position: relative; }
    .calm-bar { background: linear-gradient(90deg, #6ee7b7, #34d399, #10b981); }
    .stress-bar { background: linear-gradient(90deg, #fde68a, #fb923c, #ef4444); }
    .meter-bar-inner::after { content:''; position:absolute; top:0; left:0; right:0; height:45%; background:rgba(255,255,255,0.2); border-radius:10px; }
    /* ===== SCHOOL DAY TIMELINE ===== */
    .day-timeline { display: flex; align-items: center; padding: 10px 16px; background: rgba(255,255,255,0.08); border-radius: 14px; margin-bottom: 14px; overflow-x: auto; scrollbar-width: none; }
    .day-timeline::-webkit-scrollbar { display: none; }
    .t-dot { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; transition: all 0.3s; }
    .t-dot.done { background: #10b981; }
    .t-dot.current { background: white; box-shadow: 0 0 0 4px rgba(255,255,255,0.3); animation: tPulse 1.5s infinite; }
    .t-dot.future { background: rgba(255,255,255,0.15); filter: grayscale(60%); }
    .t-line { height: 3px; flex: 1; min-width: 10px; max-width: 36px; border-radius: 2px; }
    .t-line.done { background: #10b981; }
    .t-line.future { background: rgba(255,255,255,0.15); }
    @keyframes tPulse { 0%,100% { box-shadow: 0 0 0 4px rgba(255,255,255,0.3); } 50% { box-shadow: 0 0 0 8px rgba(255,255,255,0.1); } }
    /* ===== CARRY-FORWARD BANNERS ===== */
    .carry-banner { padding: 10px 14px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 0.88rem; animation: carryIn 0.4s ease; }
    .carry-warning { background: #fef3c7; border-left: 4px solid #f59e0b; color: #92400e; }
    .carry-boost { background: #d1fae5; border-left: 4px solid #10b981; color: #065f46; }
    .carry-encourage { background: #dbeafe; border-left: 4px solid #3b82f6; color: #1e40af; }
    @keyframes carryIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }
    /* ===== BIG METER CHANGES (consequence screen) ===== */
    .big-meter-changes { display: flex; gap: 12px; margin: 20px 0; }
    .big-change-box { flex: 1; padding: 16px 12px; border-radius: 16px; text-align: center; }
    .big-change-face { font-size: 1.8rem; margin-bottom: 4px; line-height: 1; }
    .big-change-amount { font-family: 'Fredoka One', cursive; font-size: 2.4rem; font-weight: 900; line-height: 1; }
    .big-change-label { font-size: 0.8rem; font-weight: 700; margin-top: 6px; }
    /* ===== CRISIS BANNER ===== */
    .crisis-banner { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 2px solid #3b82f6; border-radius: 16px; padding: 20px; margin: 16px 0; text-align: center; }
    .crisis-title { font-family: 'Fredoka One', cursive; font-size: 1.1rem; color: #1e40af; margin-bottom: 8px; }
    .crisis-text { color: #1e3a8a; font-size: 0.9rem; margin-bottom: 10px; line-height: 1.5; }
    .crisis-hotline { background: white; border-radius: 12px; padding: 12px 16px; margin-bottom: 8px; color: #1e3a8a; font-size: 0.95rem; line-height: 1.6; }
    .crisis-chat { color: #3b82f6; font-size: 0.85rem; }
    /* ===== REFLECTION JOURNAL ===== */
    .reflection-input { width: 100%; padding: 12px 14px; border: 2px solid #c7d2fe; border-radius: 10px; font-size: 0.9rem; font-family: inherit; margin-bottom: 14px; resize: vertical; min-height: 80px; color: #334155; }
    .reflection-input:focus { outline: none; border-color: #6366f1; }
    .response-reflection { font-size: 0.78rem; color: #6366f1; font-style: italic; margin-top: 4px; padding: 6px 10px; background: #eef2ff; border-radius: 8px; }
    .download-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #0ea5e9, #6366f1); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; font-family: inherit; margin-bottom: 10px; }
    .download-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(14,165,233,0.35); }
    /* ===== RESUME BANNER ===== */
    .resume-banner { background: linear-gradient(135deg, #d1fae5, #a7f3d0); border: 2px solid #10b981; border-radius: 14px; padding: 16px 20px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .resume-text { font-weight: 700; color: #065f46; font-size: 0.9rem; }
    .resume-btn { padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-family: inherit; white-space: nowrap; }
    .resume-btn:hover { background: #059669; }
    /* ===== DISCUSSION MODE TOGGLE ===== */
    .toggle-row { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 14px; padding: 14px 16px; margin-bottom: 18px; gap: 12px; }
    .toggle-btn { flex-shrink: 0; padding: 8px 18px; border: none; border-radius: 20px; font-weight: 800; font-size: 0.85rem; cursor: pointer; font-family: inherit; background: #e2e8f0; color: #64748b; transition: all 0.2s; }
    .toggle-btn.active { background: #6366f1; color: white; }
    /* ===== STREAK ===== */
    .streak-pill { background: rgba(251,146,60,0.18); color: #ea580c; font-weight: 800; border-radius: 20px; padding: 3px 10px; font-size: 0.78rem; margin-left: 8px; }
    .streak-bonus { background: linear-gradient(135deg, #ea580c, #f97316); color: white; border-radius: 12px; padding: 10px 16px; text-align: center; font-weight: 800; margin-bottom: 12px; font-size: 1rem; }
    .streak-bonus--sm { background: linear-gradient(135deg, #92400e, #b45309); font-size: 0.9rem; }
    /* ===== TRICKY SCENARIO BANNER ===== */
    .tricky-banner { background: linear-gradient(135deg, #fef9c3, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 10px 14px; margin-bottom: 12px; color: #78350f; font-weight: 700; font-size: 0.9rem; }
    /* ===== DISCUSSION PAUSE SCREEN ===== */
    .discussion-card { background: #1e293b; border-radius: 24px; padding: 32px; max-width: 600px; width: 100%; margin: 0 auto; }
    .discussion-badge { display: inline-block; background: #dc2626; color: white; font-weight: 800; font-size: 0.8rem; border-radius: 20px; padding: 6px 16px; letter-spacing: 1px; margin-bottom: 16px; }
    .discussion-scenario { color: white; font-size: 1.5rem; font-weight: 800; margin: 0 0 16px; }
    .discussion-choice-made { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 14px; margin-bottom: 20px; }
    .discussion-choice-label { display: block; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin-bottom: 6px; font-weight: 700; }
    .discussion-choice-text { color: #e2e8f0; font-size: 0.95rem; line-height: 1.5; font-style: italic; }
    .discussion-prompt-box { background: rgba(99,102,241,0.15); border: 2px solid rgba(99,102,241,0.4); border-radius: 14px; padding: 18px; margin-bottom: 20px; }
    .discussion-prompt-label { font-size: 0.78rem; text-transform: uppercase; letter-spacing: 1px; color: #a5b4fc; font-weight: 800; margin-bottom: 8px; }
    .discussion-prompt-text { color: #e2e8f0; font-size: 1rem; line-height: 1.65; margin: 0; }
    .discussion-hint { display: flex; align-items: center; gap: 8px; color: #64748b; font-size: 0.82rem; margin-bottom: 20px; }
    .discussion-reveal-btn { width: 100%; padding: 16px; color: white; border: none; border-radius: 14px; font-size: 1.1rem; font-weight: 800; cursor: pointer; font-family: inherit; transition: transform 0.2s; }
    .discussion-reveal-btn:hover { transform: translateY(-2px); }
    /* ===== BADGE POPUP ===== */
    .badge-popup { position: fixed; inset: 0; background: rgba(0,0,0,0.72); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .badge-popup-card { background: white; border-radius: 24px; padding: 36px 28px; text-align: center; max-width: 300px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .badge-popup-emoji { font-size: 4.5rem; margin-bottom: 12px; }
    .badge-popup-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: #6366f1; font-weight: 800; margin-bottom: 8px; }
    .badge-popup-name { font-size: 1.6rem; font-weight: 800; color: #1e293b; margin-bottom: 8px; }
    .badge-popup-desc { color: #64748b; font-size: 0.88rem; margin-bottom: 24px; }
    .badge-popup-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 800; cursor: pointer; font-family: inherit; }
    /* ===== BADGE SHELF (end screen) ===== */
    .badge-shelf { background: linear-gradient(135deg, #eef2ff, #ede9fe); border: 2px solid #a5b4fc; border-radius: 16px; padding: 20px; margin-bottom: 20px; }
    .badge-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .badge-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .badge-item-emoji { font-size: 2rem; }
    .badge-item-name { font-size: 0.65rem; font-weight: 700; color: #4338ca; text-align: center; line-height: 1.3; }
    /* ===== ANONYMOUS / TEACHER BUTTONS ===== */
    .anon-btn { width: 100%; padding: 12px; background: white; border: 2px dashed #94a3b8; border-radius: 12px; color: #64748b; font-size: 0.9rem; font-weight: 700; cursor: pointer; font-family: inherit; margin-bottom: 10px; }
    .anon-btn:hover { border-color: #6366f1; color: #6366f1; }
    .teacher-link { display: block; text-align: center; color: rgba(255,255,255,0.5); font-size: 0.78rem; margin-top: 12px; cursor: pointer; text-decoration: underline; }
    .teacher-link:hover { color: rgba(255,255,255,0.85); }
    /* ===== TEACHER VIEW ===== */
    .teacher-stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
    .teacher-stat { background: #f8fafc; border-radius: 12px; padding: 14px; text-align: center; border: 2px solid #e2e8f0; }
    .teacher-stat-val { font-family: 'Fredoka One', cursive; font-size: 1.8rem; color: #6366f1; }
    .teacher-stat-lbl { font-size: 0.75rem; color: #64748b; font-weight: 600; margin-top: 2px; }
    .scenario-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: #f8fafc; border-radius: 10px; margin-bottom: 6px; border-left: 4px solid #f43f5e; }
    .scenario-row-name { font-weight: 700; font-size: 0.88rem; color: #334155; }
    .scenario-row-count { font-weight: 800; color: #dc2626; font-size: 0.9rem; }
    .clear-btn { width: 100%; padding: 12px; background: #fee2e2; color: #dc2626; border: 2px solid #f43f5e; border-radius: 12px; cursor: pointer; font-family: inherit; font-weight: 700; margin-top: 8px; }
    .clear-btn:hover { background: #fecaca; }
  `;

  // ========== RENDER ==========

  // START SCREEN
  if (gameState === 'start') {
    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%)', fontFamily: "'Nunito', sans-serif", padding: '20px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <style>{styles}</style>
        <div className="card">
          <h1 className="title">Life Quest</h1>
          <p className="subtitle">A Social-Emotional Adventure</p>
          
          <span className="label">Select Your Grade Level</span>
          {gradeLevels.map(level => (
            <button
              key={level.id}
              className={`grade-btn ${gradeLevel === level.id ? 'selected' : ''}`}
              style={{ '--color': level.color }}
              onClick={() => setGradeLevel(level.id)}
            >
              <span className="grade-emoji">{level.emoji}</span>
              <div>
                <div className="grade-name">{level.name}</div>
                <div className="grade-range">Grades {level.grades}</div>
              </div>
            </button>
          ))}
          
          <span className="label" style={{ marginTop: 16 }}>Your Name</span>
          <input
            className="input"
            placeholder="Enter your name..."
            value={playerName}
            onChange={(e) => setPlayerName(e.target.value)}
            maxLength={20}
          />
          
          <span className="label">Customize Your Avatar</span>
          <div className="acc-preview">
            <AvatarFace stress={2} calm={6} accessories={accessories} size={130} />
          </div>
          <div className="acc-tabs">
            {[['hair','Hair'],['hat','Hat'],['glasses','Glasses'],['extra','Extras']].map(([cat, label]) => (
              <button
                key={cat}
                className={`acc-tab ${accCategory === cat ? 'active' : ''}`}
                onClick={() => setAccCategory(cat)}
              >{label}</button>
            ))}
          </div>
          <div className="acc-options">
            {ACC_OPTS[accCategory].map(opt => (
              <button
                key={opt.id}
                className={`acc-opt ${accessories[accCategory] === opt.id ? 'selected' : ''}`}
                onClick={() => setAccessories(prev => ({ ...prev, [accCategory]: opt.id }))}
              >
                <span style={{ fontSize: '1.4rem' }}>{opt.icon}</span>
                <span>{opt.label}</span>
              </button>
            ))}
          </div>
          
          <span className="label">Facilitation Mode</span>
          <div className="toggle-row">
            <div>
              <div style={{ fontWeight: 700, color: '#1e293b', fontSize: '0.9rem' }}>
                {discussionMode ? 'ğŸ›‘ Discussion Pauses ON' : 'â–¶ï¸ Individual Play Mode'}
              </div>
              <div style={{ color: '#64748b', fontSize: '0.78rem', marginTop: 2 }}>
                {discussionMode
                  ? 'Game pauses after each choice for group discussion'
                  : 'No pauses â€” students play individually at their own pace'}
              </div>
            </div>
            <button
              className={`toggle-btn ${discussionMode ? 'active' : ''}`}
              onClick={() => setDiscussionMode(prev => !prev)}
            >
              {discussionMode ? 'ON' : 'OFF'}
            </button>
          </div>

          <span className="label">How Many Scenarios?</span>
          <div className="count-btns">
            {[5, 7, 10].map(n => (
              <button
                key={n}
                className={`count-btn ${scenarioCount === n ? 'selected' : ''}`}
                onClick={() => setScenarioCount(n)}
              >
                {n}
              </button>
            ))}
          </div>
          
          {hasSavedGame && (
            <div className="resume-banner">
              <span className="resume-text">ğŸ“– You have a game in progress!</span>
              <button className="resume-btn" onClick={resumeGame}>Resume â†’</button>
            </div>
          )}

          <button
            className="start-btn"
            onClick={() => setGameState('backstory')}
            disabled={!gradeLevel || !playerName.trim()}
          >
            Continue to Character Setup ğŸš€
          </button>

          <button
            className="anon-btn"
            onClick={() => {
              if (!gradeLevel) { alert('Please select a grade level first.'); return; }
              setPlayerName('Anonymous');
              setGameState('backstory');
            }}
          >
            ğŸ™ˆ Play Anonymously
          </button>

          <span className="teacher-link" onClick={() => setGameState('teacher')}>
            Facilitator View
          </span>
        </div>
      </div>
    );
  }

  // BACKSTORY SCREEN
  if (gameState === 'backstory') {
    const ChipGroup = ({ chips, value, onChange }) => (
      <div className="chip-group">
        {chips.map(chip => (
          <button
            key={chip.id}
            className={`chip ${value === chip.label ? 'selected' : ''}`}
            onClick={() => onChange(value === chip.label ? '' : chip.label)}
          >
            <span>{chip.emoji}</span>
            <span>{chip.label}</span>
          </button>
        ))}
      </div>
    );

    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%)', fontFamily: "'Nunito', sans-serif", padding: '20px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <style>{styles}</style>
        <div className="card" style={{ maxWidth: 640 }}>
          <h1 className="title">Build Your Character</h1>
          <p className="subtitle">Tell us a little about yourself â€” tap to select</p>

          <div className="character-visual">
            <AvatarFace stress={2} calm={6} accessories={accessories} size={110} />
          </div>

          <div className="backstory-question">ğŸ§˜ What helps you feel calm?</div>
          <ChipGroup
            chips={calmActivityChips}
            value={backstoryAnswers.calmActivity}
            onChange={(v) => setBackstoryAnswers(prev => ({ ...prev, calmActivity: v }))}
          />

          <div className="backstory-question">ğŸ’¬ Who do you go to when things get hard?</div>
          <ChipGroup
            chips={supportPersonChips}
            value={backstoryAnswers.supportPerson}
            onChange={(v) => setBackstoryAnswers(prev => ({ ...prev, supportPerson: v }))}
          />

          <div className="backstory-question">ğŸŒŸ Something you're proud of recently:</div>
          <ChipGroup
            chips={proudMomentChips}
            value={backstoryAnswers.proudMoment}
            onChange={(v) => setBackstoryAnswers(prev => ({ ...prev, proudMoment: v }))}
          />

          <span className="label" style={{ marginTop: 8 }}>Your Character Strength</span>
          <p style={{ fontSize: '0.82rem', color: '#64748b', marginBottom: 14, marginTop: -6 }}>This will give you hints during tough moments</p>

          <div className="strength-grid">
            {characterStrengths.map(strength => (
              <button
                key={strength.id}
                className={`strength-btn ${characterStrength === strength.id ? 'selected' : ''}`}
                onClick={() => setCharacterStrength(strength.id)}
              >
                <span className="strength-emoji">{strength.emoji}</span>
                <span className="strength-name">{strength.name}</span>
                <span className="strength-desc">{strength.description}</span>
              </button>
            ))}
          </div>

          <button
            className="start-btn"
            onClick={startGame}
            disabled={!characterStrength || !backstoryAnswers.calmActivity.trim() || !backstoryAnswers.supportPerson.trim() || !backstoryAnswers.proudMoment.trim()}
          >
            Begin Your Day! ğŸš€
          </button>
        </div>
      </div>
    );
  }

  // TEACHER / FACILITATOR VIEW
  if (gameState === 'teacher') {
    const tData = getTeacherData();
    const totalSessions = tData.length;
    const avgScore = totalSessions > 0
      ? Math.round(tData.reduce((a, s) => a + (s.score / s.maxScore) * 100, 0) / totalSessions)
      : 0;
    const gradeLabels = { elementary: 'K-5', middle: '6-8', high: '9-12' };
    const byGrade = {};
    tData.forEach(s => {
      const g = gradeLabels[s.gradeLevel] || s.gradeLevel;
      byGrade[g] = (byGrade[g] || 0) + 1;
    });
    const scenarioDifficulty = {};
    tData.forEach(s => {
      s.responses.forEach(r => {
        if (r.points < 0) scenarioDifficulty[r.scenario] = (scenarioDifficulty[r.scenario] || 0) + 1;
      });
    });
    const hardest = Object.entries(scenarioDifficulty).sort(([,a],[,b]) => b-a).slice(0, 5);
    const crisisCount = tData.reduce((n, s) =>
      n + s.responses.filter(r => ['Catastrophic Thinking','Alarming Deflection'].includes(r.skill) && r.points < 0).length, 0);

    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%)', fontFamily: "'Nunito', sans-serif", padding: '20px' }}>
        <style>{styles}</style>
        <div className="results-card">
          <div className="trophy">ğŸ“Š</div>
          <h1 className="results-title">Facilitator View</h1>
          <p className="level-msg">Aggregate data from sessions played on this device</p>

          {totalSessions === 0 ? (
            <div style={{ textAlign: 'center', padding: '40px 20px', color: '#64748b' }}>
              <div style={{ fontSize: '3rem', marginBottom: 12 }}>ğŸ•¹ï¸</div>
              <p>No sessions recorded yet. Have students play the game first!</p>
            </div>
          ) : (
            <>
              <div className="teacher-stat-grid">
                <div className="teacher-stat">
                  <div className="teacher-stat-val">{totalSessions}</div>
                  <div className="teacher-stat-lbl">Sessions Played</div>
                </div>
                <div className="teacher-stat">
                  <div className="teacher-stat-val">{avgScore}%</div>
                  <div className="teacher-stat-lbl">Avg Score</div>
                </div>
                <div className="teacher-stat">
                  <div className="teacher-stat-val" style={{ color: crisisCount > 0 ? '#dc2626' : '#10b981' }}>{crisisCount}</div>
                  <div className="teacher-stat-lbl">Crisis Flags ğŸ’™</div>
                </div>
              </div>

              {Object.keys(byGrade).length > 0 && (
                <>
                  <span className="label">Grade Breakdown</span>
                  <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', marginBottom: 16 }}>
                    {Object.entries(byGrade).map(([g, n]) => (
                      <div key={g} style={{ padding: '8px 16px', background: '#eef2ff', borderRadius: 20, fontWeight: 700, color: '#4338ca', fontSize: '0.88rem' }}>
                        Grades {g}: {n} session{n !== 1 ? 's' : ''}
                      </div>
                    ))}
                  </div>
                </>
              )}

              {hardest.length > 0 && (
                <>
                  <span className="label">ğŸ”´ Scenarios Students Struggled With Most</span>
                  <div style={{ marginBottom: 16 }}>
                    {hardest.map(([name, count]) => (
                      <div key={name} className="scenario-row">
                        <span className="scenario-row-name">{name}</span>
                        <span className="scenario-row-count">{count} negative choice{count !== 1 ? 's' : ''}</span>
                      </div>
                    ))}
                  </div>
                  <p style={{ fontSize: '0.82rem', color: '#94a3b8', marginBottom: 16 }}>
                    ğŸ’¡ These scenarios may be worth discussing as a class.
                  </p>
                </>
              )}

              <span className="label">Recent Sessions</span>
              <div className="response-list" style={{ maxHeight: 200 }}>
                {[...tData].reverse().slice(0, 20).map((s, i) => (
                  <div key={i} className="response-item" style={{ borderColor: (s.score / s.maxScore) >= 0.6 ? '#10b981' : '#f43f5e' }}>
                    <span className="response-points" style={{ color: (s.score / s.maxScore) >= 0.6 ? '#059669' : '#dc2626' }}>
                      {Math.round((s.score / s.maxScore) * 100)}%
                    </span>
                    <div className="response-scenario">{s.playerName} â€” Grades {gradeLabels[s.gradeLevel] || s.gradeLevel}</div>
                    <div className="response-skill">{s.scenarioCount} scenarios â€¢ Score {s.score}/{s.maxScore}</div>
                    <div className="response-stress">{new Date(s.ts).toLocaleDateString()}</div>
                  </div>
                ))}
              </div>
            </>
          )}

          <button className="restart-btn" onClick={() => setGameState('start')} style={{ marginBottom: 8 }}>
            â† Back to Game
          </button>
          {totalSessions > 0 && (
            <button className="clear-btn" onClick={() => {
              if (window.confirm('Clear all session data? This cannot be undone.')) {
                localStorage.removeItem('sel_teacher_data');
                setGameState('start');
              }
            }}>
              ğŸ—‘ï¸ Clear All Session Data
            </button>
          )}
        </div>
      </div>
    );
  }

  // PLAYING SCREEN
  if (gameState === 'playing' && currentScenario) {
    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%)', fontFamily: "'Nunito', sans-serif", padding: '20px' }}>
        <style>{styles}</style>
        <div style={{ maxWidth: 700, margin: '0 auto' }}>
          <div className="header">
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <div className="avatar" style={{ background: 'transparent', overflow: 'visible' }}>
                <AvatarFace stress={stress} calm={calm} accessories={accessories} size={42} />
              </div>
              <span className="player-name">{playerName}</span>
              {streak >= 2 && <span className="streak-pill">ğŸ”¥ {streak}</span>}
            </div>
            <div style={{ textAlign: 'right' }}>
              <div className="progress">Scenario {currentIndex + 1} of {scenarios.length}</div>
              <div className="score">Score: {score}</div>
            </div>
          </div>
          
          {/* School Day Timeline */}
          <div className="day-timeline">
            {getDayTimeline().map((step, i, arr) => (
              <React.Fragment key={step.order}>
                {i > 0 && <div className={`t-line ${arr[i-1].done ? 'done' : 'future'}`} />}
                <div className={`t-dot ${step.done ? 'done' : step.current ? 'current' : 'future'}`}>
                  {step.emoji}
                </div>
              </React.Fragment>
            ))}
          </div>

          {/* Game-Style Meters */}
          <div className="game-meters">
            <div className="game-meter calm-meter">
              <div className="meter-top">
                <span className="meter-face-icon">{getCalmFace(calm)}</span>
                <div className="meter-meta">
                  <div className="meter-name">Calm</div>
                  <div className="meter-status-label">{getCalmLabel(calm)}</div>
                </div>
              </div>
              <div className="meter-bar-outer">
                <div className="meter-bar-inner calm-bar" style={{ width: `${(calm/10)*100}%` }} />
              </div>
            </div>
            <div className="game-meter stress-meter">
              <div className="meter-top">
                <span className="meter-face-icon">{getStressFace(stress)}</span>
                <div className="meter-meta">
                  <div className="meter-name">Stress</div>
                  <div className="meter-status-label">{getStressLabel(stress)}</div>
                </div>
              </div>
              <div className="meter-bar-outer">
                <div className="meter-bar-inner stress-bar" style={{ width: `${(stress/12)*100}%` }} />
              </div>
            </div>
          </div>

          <div style={{ background: 'white', borderRadius: '20px', padding: '20px', marginBottom: '14px' }}>
            <div className="character-visual">
              <AvatarFace stress={stress} calm={calm} accessories={accessories} size={120} />
            </div>
            <div className="thought-bubble">
              <div className="thought-text">
                <span className="thought-emoji">ğŸ’­</span>
                {getInnerThought()}
              </div>
            </div>
          </div>

          <div className="scenario-card">
            {currentScenario.stressModifier?.active && (
              <div className={`warning ${stress >= 9 ? 'high-stress' : 'stress'}`}>
                <span>{stress >= 9 ? 'ğŸ”¥' : 'âš ï¸'}</span>
                <span>{currentScenario.stressModifier.effect}</span>
              </div>
            )}
            {currentScenario.wellbeingModifier?.active && (
              <div className="warning wellbeing">
                <span>âœ¨</span>
                <span>{currentScenario.wellbeingModifier.effect}</span>
              </div>
            )}

            {/* Carry-forward consequence banners */}
            {carryForwardMsgs.map((msg, i) => (
              <div key={i} className={`carry-banner carry-${msg.type}`}>
                <span style={{ fontSize: '1.3rem' }}>{msg.icon}</span>
                <span>{msg.text}</span>
              </div>
            ))}

            <div className="scenario-header">
              <div className="scenario-num" style={{ background: levelColor }}>{currentIndex + 1}</div>
              <div>
                <h2 className="scenario-title">{scenarios[currentIndex].title}</h2>
                <span className="scenario-time">{scenarios[currentIndex].timeOfDay}</span>
              </div>
            </div>
            
            <p className="situation">{currentScenario.situation}</p>

            {stress >= 6 && characterStrength && (
              <div className="hint-box">
                <span style={{ fontSize: '1.5rem' }}>
                  {characterStrengths.find(s => s.id === characterStrength)?.emoji}
                </span>
                <div>
                  <div style={{ fontWeight: 800, color: '#92400e', marginBottom: 4 }}>
                    {characterStrengths.find(s => s.id === characterStrength)?.name} says:
                  </div>
                  <div className="hint-text">
                    {characterStrengths.find(s => s.id === characterStrength)?.hint}
                  </div>
                </div>
              </div>
            )}

            {scenarios[currentIndex]?.isTricky && (
              <div className="tricky-banner">
                âš¡ No easy answer here â€” think carefully before you choose
              </div>
            )}
            <div className="choices-label">What do you do?</div>
            {shuffledChoices.map((choice, i) => (
              <button key={i} className="choice-btn" onClick={() => handleChoice(choice)}>
                {choice.text}
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // DISCUSSION PAUSE SCREEN
  if (gameState === 'discussion' && selectedChoice) {
    const prompt = DISCUSSION_PROMPTS[scenarios[currentIndex]?.id];
    const isPositive = selectedChoice.points > 0;
    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 60%, #0f172a 100%)', fontFamily: "'Nunito', sans-serif", padding: '20px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <style>{styles}</style>
        <div className="discussion-card">
          <div className="discussion-badge">ğŸ›‘ Facilitator Pause</div>
          <h2 className="discussion-scenario">{scenarios[currentIndex]?.title}</h2>
          <div className="discussion-choice-made">
            <span className="discussion-choice-label">Choice made:</span>
            <span className="discussion-choice-text">"{selectedChoice.text}"</span>
          </div>
          {prompt && (
            <div className="discussion-prompt-box">
              <div className="discussion-prompt-label">ğŸ’¬ Ask the group:</div>
              <p className="discussion-prompt-text">{prompt}</p>
            </div>
          )}
          <div className="discussion-hint">
            <span>ğŸ•</span>
            <span>Give the group time to discuss before revealing what happens next</span>
          </div>
          <button
            className="discussion-reveal-btn"
            style={{ background: isPositive ? 'linear-gradient(135deg,#059669,#10b981)' : 'linear-gradient(135deg,#b91c1c,#ef4444)' }}
            onClick={() => setGameState('consequence')}
          >
            Reveal What Happens â†’
          </button>
        </div>
      </div>
    );
  }

  // CONSEQUENCE SCREEN
  if (gameState === 'consequence' && selectedChoice && modifiedConsequence) {
    const isPositive = selectedChoice.points > 0;
    const total = selectedChoice.points + modifiedConsequence.bonusPoints;
    
    return (
      <div style={{
        minHeight: '100vh',
        background: isPositive 
          ? 'linear-gradient(135deg, #064e3b 0%, #065f46 50%, #047857 100%)'
          : 'linear-gradient(135deg, #7f1d1d 0%, #991b1b 50%, #b91c1c 100%)',
        fontFamily: "'Nunito', sans-serif",
        padding: '20px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center'
      }}>
        <style>{styles}</style>
        <div className="consequence-card">
          {streak >= 3 && isPositive && (
            <div className="streak-bonus">ğŸ”¥ {streak} in a row! On fire!</div>
          )}
          {streak === 2 && isPositive && (
            <div className="streak-bonus streak-bonus--sm">ğŸ”¥ 2 in a row â€” keep it going!</div>
          )}
          <div className="result-emoji">{selectedChoice.emoji}</div>
          <div className="points" style={{ color: isPositive ? '#059669' : '#dc2626' }}>
            {total > 0 ? '+' : ''}{total} {total === 1 ? 'Point' : 'Points'}
          </div>
          {modifiedConsequence.bonusPoints > 0 && (
            <div className="bonus">+{modifiedConsequence.bonusPoints} Resilience Bonus!</div>
          )}
          <div className="skill-tag" style={{ background: isPositive ? '#d1fae5' : '#fee2e2', color: isPositive ? '#065f46' : '#991b1b' }}>
            {selectedChoice.skill}
          </div>
          <p className="consequence-text">{modifiedConsequence.consequence}</p>
          
          <div className="big-meter-changes">
            <div className="big-change-box" style={{ background: modifiedConsequence.calmChange >= 0 ? '#d1fae5' : '#fee2e2' }}>
              <div className="big-change-face">{getCalmFace(calm)}</div>
              <div className="big-change-amount" style={{ color: modifiedConsequence.calmChange >= 0 ? '#059669' : '#dc2626' }}>
                {modifiedConsequence.calmChange > 0 ? '+' : ''}{modifiedConsequence.calmChange}
              </div>
              <div className="big-change-label" style={{ color: modifiedConsequence.calmChange >= 0 ? '#065f46' : '#991b1b' }}>ğŸ˜Š Calm</div>
            </div>
            <div className="big-change-box" style={{ background: modifiedConsequence.stressChange <= 0 ? '#d1fae5' : '#fee2e2' }}>
              <div className="big-change-face">{getStressFace(stress)}</div>
              <div className="big-change-amount" style={{ color: modifiedConsequence.stressChange <= 0 ? '#059669' : '#dc2626' }}>
                {modifiedConsequence.stressChange > 0 ? '+' : ''}{modifiedConsequence.stressChange}
              </div>
              <div className="big-change-label" style={{ color: modifiedConsequence.stressChange <= 0 ? '#065f46' : '#991b1b' }}>ğŸ˜¤ Stress</div>
            </div>
          </div>
          
          {isCrisisChoice(selectedChoice) && (
            <div className="crisis-banner">
              <div style={{ fontSize: '1.8rem', marginBottom: '6px' }}>ğŸ’™</div>
              <div className="crisis-title">You don't have to feel this alone</div>
              <div className="crisis-text">
                If you're having dark or overwhelming thoughts, please reach out for support:
              </div>
              <div className="crisis-hotline">
                <strong>988 Suicide & Crisis Lifeline</strong><br />
                Call or text <strong>988</strong> â€” available 24/7, free & confidential
              </div>
              <div className="crisis-chat">Or chat at 988lifeline.org</div>
            </div>
          )}

          <button className="next-btn" style={{ background: isPositive ? '#059669' : '#dc2626' }} onClick={() => setShowReflection(true)}>
            Continue â†’
          </button>
        </div>

        {newBadge && (
          <div className="badge-popup" onClick={() => setNewBadge(null)}>
            <div className="badge-popup-card" onClick={e => e.stopPropagation()}>
              <div className="badge-popup-emoji">{newBadge.emoji}</div>
              <div className="badge-popup-title">Badge Unlocked!</div>
              <div className="badge-popup-name">{newBadge.name}</div>
              <div className="badge-popup-desc">{newBadge.desc}</div>
              <button className="badge-popup-btn" onClick={() => setNewBadge(null)}>Awesome! â†’</button>
            </div>
          </div>
        )}

        {showReflection && (
          <div className="modal">
            <div className="modal-content">
              <h3 className="modal-title">ğŸ¤” Quick Reflection</h3>
              <p className="modal-text">
                {isPositive
                  ? "What made this choice helpful in this situation?"
                  : "What might have been a better approach here?"
                }
              </p>
              {stress >= 6 && (
                <div className="modal-hint">
                  ğŸ’¡ Notice how your stress level affected this situation!
                </div>
              )}
              <textarea
                className="reflection-input"
                placeholder="Write your thoughts here... (optional)"
                value={reflectionText}
                onChange={(e) => setReflectionText(e.target.value)}
                maxLength={300}
              />
              <button className="modal-btn" onClick={nextScenario}>
                {reflectionText.trim() ? 'Save & Continue âœï¸' : 'Continue â†’'}
              </button>
            </div>
          </div>
        )}
      </div>
    );
  }

  // COMPLETE SCREEN
  if (gameState === 'complete') {
    const scoreInfo = getScoreLevel();
    const max = scenarioCount * 3;
    const min = scenarioCount * -2;
    const pct = Math.max(0, ((score - min) / (max - min)) * 100);
    const avgStress = stressHistory.reduce((a, b) => a + b, 0) / stressHistory.length;
    const peakStress = Math.max(...stressHistory);
    const endStress = stressHistory[stressHistory.length - 1];
    
    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%)', fontFamily: "'Nunito', sans-serif", padding: '20px' }}>
        <style>{styles}</style>
        <div className="results-card">
          <div className="trophy">ğŸ†</div>
          <h1 className="results-title">Day Complete!</h1>
          <span className="level-badge" style={{ background: scoreInfo.color }}>{scoreInfo.level}</span>
          <p className="level-msg">{scoreInfo.msg}</p>

          {characterStrength && (
            <div style={{ background: '#eef2ff', borderRadius: '12px', padding: '16px', marginBottom: '16px', border: '2px solid #6366f1' }}>
              <div style={{ textAlign: 'center', marginBottom: '8px', fontSize: '2rem' }}>
                {characterStrengths.find(s => s.id === characterStrength)?.emoji}
              </div>
              <div style={{ textAlign: 'center', fontWeight: 700, color: '#4338ca', marginBottom: '6px' }}>
                Your {characterStrengths.find(s => s.id === characterStrength)?.name} strength helped guide you!
              </div>
              <div style={{ textAlign: 'center', fontSize: '0.85rem', color: '#6366f1' }}>
                {backstoryAnswers.calmActivity && `Remember, ${backstoryAnswers.calmActivity.toLowerCase()} helps you stay calm.`}
              </div>
            </div>
          )}

          <div className="final-score-box">
            <div className="final-score">{score}</div>
            <div className="score-max">out of {max} possible points</div>
            <div className="progress-bar">
              <div className="progress-fill" style={{ width: `${pct}%` }} />
            </div>
          </div>
          
          <div className="journey-box">
            <div className="journey-title">ğŸ“Š How Your Day Went</div>
            <div className="journey-stats">
              <div className="journey-stat">
                <div className="journey-stat-value">ğŸ˜Š {responses.length > 0 ? responses[responses.length-1].calmAfter ?? 'â€”' : calm}</div>
                <div className="journey-stat-label">Final Calm</div>
              </div>
              <div className="journey-stat">
                <div className="journey-stat-value">ğŸ˜¤ {peakStress}</div>
                <div className="journey-stat-label">Peak Stress</div>
              </div>
              <div className="journey-stat">
                <div className="journey-stat-value">ğŸ˜Œ {endStress}</div>
                <div className="journey-stat-label">Final Stress</div>
              </div>
            </div>
            <div className="journey-insight">
              {endStress <= 3
                ? "ğŸŒŸ You finished with low stress! Your coping choices kept you balanced."
                : endStress <= 6
                ? "ğŸ‘ You managed stress reasonably well through the day."
                : "âš ï¸ Stress built up over your day. Notice how earlier choices affected later situations!"
              }
            </div>
          </div>

          {badges.length > 0 && (
            <div className="badge-shelf">
              <div className="journey-title" style={{ color: '#4338ca', marginBottom: 14 }}>ğŸ… Badges Earned</div>
              <div className="badge-grid">
                {badges.map(b => (
                  <div key={b.id} className="badge-item" title={b.desc}>
                    <div className="badge-item-emoji">{b.emoji}</div>
                    <div className="badge-item-name">{b.name}</div>
                  </div>
                ))}
              </div>
              {BADGES.filter(b => !badges.some(e => e.id === b.id)).length > 0 && (
                <div style={{ marginTop: 12, borderTop: '1px solid #e2e8f0', paddingTop: 12 }}>
                  <div style={{ fontSize: '0.75rem', color: '#94a3b8', marginBottom: 8, fontWeight: 700 }}>NOT YET EARNED</div>
                  <div className="badge-grid">
                    {BADGES.filter(b => !badges.some(e => e.id === b.id)).map(b => (
                      <div key={b.id} className="badge-item badge-item--locked" title={b.desc}>
                        <div className="badge-item-emoji" style={{ filter: 'grayscale(1)', opacity: 0.35 }}>{b.emoji}</div>
                        <div className="badge-item-name" style={{ color: '#cbd5e1' }}>{b.name}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
          
          <span className="label">ğŸ“‹ Your Day</span>
          <div className="response-list">
            {responses.map((r, i) => (
              <div key={i} className="response-item" style={{ borderColor: r.points > 0 ? '#10b981' : r.points < 0 ? '#f43f5e' : '#f59e0b' }}>
                <span className="response-points" style={{ color: r.points > 0 ? '#059669' : '#dc2626' }}>
                  {r.points > 0 ? '+' : ''}{r.points}
                </span>
                <div className="response-scenario">{r.timeOfDay} {r.scenario}</div>
                <div className="response-skill">{r.skill}</div>
                <div className="response-stress">ğŸ˜¤ Stress: {r.stressAfter} &nbsp;|&nbsp; ğŸ˜Š Calm: {r.calmAfter ?? 'â€”'}</div>
                {r.reflection && (
                  <div className="response-reflection">âœï¸ "{r.reflection}"</div>
                )}
              </div>
            ))}
          </div>

          {responses.some(r => r.reflection) && (
            <button className="download-btn" onClick={downloadJournal}>
              ğŸ“¥ Download My Reflection Journal
            </button>
          )}

          <button className="restart-btn" onClick={() => { localStorage.removeItem('sel_saved_game'); setGameState('start'); }}>
            Play Again ğŸ”„
          </button>
        </div>
      </div>
    );
  }

  return null;
}
